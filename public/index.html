<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>فريق العون الذكي</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #0d1117;
      color: #e5e7eb;
      line-height: 1.6;
    }
    h1,h2,h3,h4,h5,h6 { font-family: 'Tajawal', sans-serif; margin-bottom: 1rem; }
    p { margin-bottom: 1.5rem; }
    .text-gradient {
      background: linear-gradient(90deg, #60a5fa, #8b5cf6, #ec4899);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .hero-section {
      background: url('https://images.unsplash.com/photo-1516117172878-fd2dc7981503?q=80&w=2070&auto=format&fit=crop') no-repeat center center/cover;
      position: relative; padding: 8rem 0; overflow: hidden;
    }
    .hero-overlay { background-color: rgba(13,17,23,.8); position: absolute; inset: 0; }
    .btn-gradient {
      background: linear-gradient(90deg, #60a5fa, #8b5cf6);
      transition: transform .3s, box-shadow .3s;
      box-shadow: 0 4px 10px rgba(0,0,0,.2); position: relative; z-index: 10;
    }
    .btn-gradient:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,.3); }
    .card {
      background-color: #161b22; border: 1px solid #30363d;
      transition: transform .3s, box-shadow .3s;
      box-shadow: 0 4px 8px rgba(0,0,0,.2);
    }
    .card:hover { transform: translateY(-10px); box-shadow: 0 15px 25px rgba(0,0,0,.4); background-color: #1f242b; }
    .robot-card {
      display:flex; flex-direction:column; align-items:center; text-align:center;
      background:#161b22; padding:1.5rem; border-radius:1rem;
      border:1px solid #30363d; box-shadow:0 4px 8px rgba(0,0,0,.2);
      transition:transform .3s; position:relative; overflow:hidden; cursor:pointer;
    }
    .robot-card:hover { transform: translateY(-10px); }
    .robot-circle {
      width:120px; height:120px; border-radius:50%;
      background:linear-gradient(to right, #60a5fa, #8b5cf6);
      display:flex; justify-content:center; align-items:center; position:relative; overflow:hidden;
    }
    .robot-image { width:100%; height:100%; object-fit:cover; transition:transform .3s; }
    .robot-card:hover .robot-image { transform:scale(1.1); }
    .faq-item { background:#161b22; padding:1.5rem; border-radius:.75rem; border:1px solid #30363d; cursor:pointer; transition:background-color .3s; }
    .faq-item:hover { background:#1f242b; }
    .faq-question { display:flex; justify-content:space-between; align-items:center; }
    .faq-answer { max-height:0; overflow:hidden; transition:max-height .3s; }
    .faq-item.active .faq-answer { max-height:200px; }
    .faq-icon { transform:rotate(0); transition:transform .3s; }
    .faq-item.active .faq-icon { transform:rotate(180deg); }
    .discount-badge {
      background: linear-gradient(90deg, #60a5fa, #8b5cf6, #ec4899);
      color:#fff; padding:.5rem 1.5rem; border-radius:9999px; font-weight:bold; font-size:1.125rem;
      position:absolute; top:-1.5rem; right:-1.5rem; transform:rotate(45deg); transform-origin:bottom left; box-shadow:0 4px 10px rgba(0,0,0,.2);
    }
    .price-box { position:relative; display:inline-block; }
    .icon-svg { width:48px; height:48px; color:#10b981; margin-bottom:1rem; }
    .modal { display:none; position:fixed; z-index:100; inset:0; overflow:auto; background:rgba(0,0,0,.7); backdrop-filter:blur(5px); justify-content:center; align-items:center; }
    .modal-content { background:#161b22; padding:2rem; border:1px solid #30363d; width:90%; max-width:400px; border-radius:1rem; box-shadow:0 10px 25px rgba(0,0,0,.5); animation:fadeIn .3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
    .close-btn { color:#aaa; float:right; font-size:28px; font-weight:bold; }
    .close-btn:hover, .close-btn:focus { color:#fff; text-decoration:none; cursor:pointer; }
    #chat-interface { display:none; position:fixed; inset:0; background:#0d1117; z-index:90; display:flex; flex-direction:column; justify-content:space-between; padding:1rem; }
    #chat-header { background:#161b22; padding:1rem; border-bottom:1px solid #30363d; text-align:center; font-size:1.5rem; font-weight:bold; }
    #chat-messages { flex-grow:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:1rem; }
    .chat-message { padding:.75rem 1rem; border-radius:.75rem; max-width:80%; word-break:break-word; white-space:pre-wrap; }
    .user-message { background:#60a5fa; color:#fff; align-self:flex-end; text-align:right; }
    .ai-message { background:#8b5cf6; color:#fff; align-self:flex-start; text-align:left; }
    #chat-input-container { display:flex; gap:.5rem; padding:1rem 0; border-top:1px solid #30363d; position:relative; }
    #chat-input { flex-grow:1; background:#161b22; border:1px solid #30363d; padding:.75rem 1rem; border-radius:9999px; color:#fff; }
    #chat-send-btn { background:#60a5fa; color:#fff; padding:.75rem 1.5rem; border-radius:9999px; font-weight:bold; cursor:pointer; transition:background-color .3s; }
    #chat-send-btn:hover { background:#8b5cf6; }
    #file-upload-icon { cursor:pointer; font-size:1.5rem; position:absolute; left:1rem; top:50%; transform:translateY(-50%); color:#8b5cf6; }
    #main-dashboard { display:none; }

    /* ======== تحسينات الموبايل والتمرير/اللوحة ======== */
    html, body { height:100%; overscroll-behavior-y:contain; }
    * { -webkit-tap-highlight-color: transparent; }
    :root { --vh: 1vh; }
    .full-viewport { min-height: 100dvh; min-height: calc(var(--vh) * 100); }
    /* kept original -webkit-overflow-scrolling */
    #robot-chat-messages, #setup-chat-messages { -webkit-overflow-scrolling: touch; scroll-behavior: smooth; overscroll-behavior: contain; }
    #robot-chat-interface, #setup-chat-interface {
      height: 100dvh; height: calc(var(--vh) * 100);
      padding-bottom: max(env(safe-area-inset-bottom, 0px), 0px);
    }
    #robot-chat-interface .chat-input-bar, #setup-chat-interface .chat-input-bar {
      position: sticky; bottom: 0; left: 0; right: 0;
      background: rgba(22,27,34,.9); backdrop-filter: blur(6px);
      border-top: 1px solid #30363d; z-index: 5;
    }
    #robot-chat-messages, #setup-chat-messages { padding-bottom: 88px; }
    #scroll-to-bottom {
      position: fixed; inset-inline-end: 1rem; inset-block-end: calc(1rem + env(safe-area-inset-bottom, 0px));
      background: #8b5cf6; color:#fff; border-radius:9999px; padding:.6rem 1rem; font-weight:700;
      box-shadow: 0 10px 20px rgba(0,0,0,.35); display:none; z-index:60;
    }
    #scroll-to-bottom.show { display:inline-flex; align-items:center; gap:.5rem; }
  </style>
</head>
<body class="antialiased">

  <!-- Header -->
  <header class="p-6 relative z-20" id="main-header">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-3xl font-bold text-white">فريق العون الذكي</h1>
      <a href="#" id="login-btn" class="btn-gradient text-white px-6 py-2 rounded-full font-semibold">تسجيل الدخول</a>
    </div>
  </header>

  <!-- Main Landing Page Content -->
  <main id="main-content">
    <section class="hero-section text-center relative flex items-center justify-center">
      <div class="hero-overlay"></div>
      <div class="container mx-auto px-4 relative z-10 py-16">
        <h2 class="text-5xl md:text-7xl font-extrabold leading-tight mb-4 text-white">
          <span class="text-gradient">أنجز أكثر</span> مع فريق العون الذكي
        </h2>
        <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-3xl mx-auto">
          نقدم لك فريقاً متخصصاً من 12 مساعداً، كل منهم جاهز لإنجاز مهمة محددة بدقة وكفاءة.
        </p>
        <a href="#" class="btn-gradient text-white text-lg px-8 py-4 rounded-full">ابدأ الآن</a>
      </div>
    </section>

    <!-- Pricing Section -->
    <section class="py-20 bg-gray-900 text-center">
      <div class="container mx-auto px-4">
        <h3 class="text-4xl font-bold mb-4 text-white">عرض حصري مدى الحياة</h3>
        <p class="text-xl text-gray-400 mb-8 max-w-2xl mx-auto">
          احصل على وصول كامل وغير محدود إلى جميع المساعدين بسعر استثنائي يدفع لمرة واحدة.
        </p>
        <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 max-w-lg mx-auto relative overflow-hidden">
          <div class="discount-badge">خصم ٩٠%</div>
          <div class="relative z-10 flex flex-col items-center">
            <p class="text-5xl font-extrabold text-white mb-2">
              <span class="text-2xl line-through text-gray-500">200$</span>
              <span class="text-gradient text-6xl">39$</span>
            </p>
            <p class="text-gray-400 mb-6">للوصول مدى الحياة</p>
            <a href="#" class="btn-gradient text-white text-lg px-8 py-4 rounded-full">اشترِ الآن</a>
          </div>
        </div>
      </div>
    </section>

    <!-- What You Get Section -->
    <section class="py-20">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-4xl font-bold mb-4 text-white">ما الذي ستحصل عليه؟</h3>
        <p class="text-xl text-gray-400 mb-12 max-w-3xl mx-auto">مقابل السعر الذي تدفعه لمرة واحدة، ستحصل على مزايا لا حصر لها.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 text-center">
            <svg class="icon-svg mx-auto" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <h4 class="text-2xl font-bold mb-2 text-white">جميع المساعدين الـ12</h4>
            <p class="text-gray-400">وصول كامل إلى كل مساعد من مساعدي الذكاء الاصطناعي الـ12.</p>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 text-center">
            <svg class="icon-svg mx-auto" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <h4 class="text-2xl font-bold mb-2 text-white">تحديثات مدى الحياة</h4>
            <p class="text-gray-400">جميع التحديثات المستقبلية والمساعدين الجدد مجاناً.</p>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 text-center">
            <svg class="icon-svg mx-auto" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <h4 class="text-2xl font-bold text-white">حل متكامل</h4>
            <p class="text-gray-400">وداعاً للتبديل بين التطبيقات، فريق العون الذكي هو كل ما تحتاجه في مكان واحد.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Features Section -->
    <section class="py-20 bg-gray-900">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-4ل font-bold mb-4 text-white">لماذا فريق العون الذكي؟</h3>
        <p class="text-xl text-gray-400 mb-12 max-w-2xl mx-auto">
          لأننا نؤمن بأن التخصص يولد الكفاءة. بدلاً من الاعتماد على أداة واحدة، نقدم لك فريقاً متكاملاً لإدارة كل جانب من جوانب عملك.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
            <div class="text-5xl mb-4 text-gradient">✨</div>
            <h4 class="text-2xl font-bold mb-2 text-white">تخصص لا مثيل له</h4>
            <p class="text-gray-400">كل مساعد مصمم خصيصاً لإتقان مهمته، من التسويق إلى التحليل.</p>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
            <div class="text-5xl mb-4 text-gradient">🚀</div>
            <h4 class="text-2xl font-bold mb-2 text-white">إنجاز المهام بسرعة</h4>
            <p class="text-gray-400">قلل الوقت المستغرق في المهام المتكررة وركز على الابتكار والنمو.</p>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
            <div class="text-5xl mb-4 text-gradient">🔗</div>
            <h4 class="text-2xl font-bold text-white">حل متكامل</h4>
            <p class="text-gray-400">وداعاً للتبديل بين التطبيقات، فريق العون الذكي هو كل ما تحتاجه في مكان واحد.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- How It Works Section -->
    <section class="py-20">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-4xl font-bold mb-4 text-white">كيف يعمل فريق العون الذكي؟</h3>
        <p class="text-xl text-gray-400 mb-12 max-w-3xl mx-auto">العملية بسيطة ومباشرة، مصممة لتوفير الوقت والجهد.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="flex flex-col items-center">
            <div class="text-6xl text-gradient mb-4">1</div>
            <h4 class="text-2xl font-bold mb-2 text-white">اختر المساعد المناسب</h4>
            <p class="text-gray-400">تصفح قائمتنا واختر المساعد الذي يتناسب مع مهمتك الحالية.</p>
          </div>
          <div class="flex flex-col items-center">
            <div class="text-6xl text-gradient mb-4">2</div>
            <h4 class="text-2xl font-bold mb-2 text-white">أعطه مهمتك</h4>
            <p class="text-gray-400">أدخل التفاصيل المطلوبة، وسيبدأ المساعد في العمل على الفور.</p>
          </div>
          <div class="flex flex-col items-center">
            <div class="text-6xl text-gradient mb-4">3</div>
            <h4 class="text-2xl font-bold mb-2 text-white">استلم النتائج</h4>
            <p class="text-gray-400">سوف تحصل على نتائج دقيقة وعالية الجودة في وقت قياسي.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- AI Helpers Section -->
    <section class="py-20 bg-gray-900">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-4xl font-bold mb-4 text-white">تعرف على فريقك</h3>
        <p class="text-xl text-gray-400 mb-12 max-w-3xl mx-auto">12 مساعداً ذكياً، كل منهم يمثل خبرة محددة.</p>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6" id="robots-grid">
          <!-- سيتم ملؤها برمجياً كما كان -->
        </div>
      </div>
    </section>

    <!-- Testimonials Section -->
    <section class="py-20">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-4xl font-bold mb-4 text-white">ماذا يقول عملاؤنا؟</h3>
        <p class="text-xl text-gray-400 mb-12 max-w-2xl mx-auto">قصص نجاح حقيقية من أشخاص وشركات حول العالم.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 text-left">
            <p class="text-lg text-gray-300 mb-4">"فريق العون الذكي غير قواعد اللعبة بالنسبة لشركتنا."</p>
            <p class="font-bold text-white">- أحمد، رائد أعمال</p>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 text-left">
            <p class="text-lg text-gray-300 mb-4">"مساعد التسويق عبر البريد الإلكتروني وفّر ساعات وزاد المبيعات."</p>
            <p class="font-bold text-white">- سارة، مديرة تسويق</p>
          </div>
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 text-left">
            <p class="text-lg text-gray-300 mb-4">"تحليل البيانات صار أسهل بكثير مع مينا."</p>
            <p class="font-bold text-white">- خالد، محلل بيانات</p>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="py-20 bg-gray-900">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-4xl font-bold mb-4 text-white">الأسئلة الشائعة</h3>
        <p class="text-xl text-gray-400 mb-12 max-w-3xl mx-auto">إجابات على الأسئلة الأكثر شيوعًا.</p>
        <div class="space-y-4 max-w-3xl mx-auto">
          <div class="faq-item">
            <div class="faq-question">
              <h5 class="font-bold text-white">هل يمكنني استخدام أكثر من مساعد في نفس الوقت؟</h5>
              <svg class="faq-icon w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="faq-answer mt-4 text-gray-400">
              <p>نعم، يمكنك استخدام أي عدد من المساعدين بالتوازي—كل مساعد يعمل بشكل مستقل.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question">
              <h5 class="font-bold text-white">هل تتوفر نسخة تجريبية مجانية؟</h5>
              <svg class="faq-icon w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="faq-answer mt-4 text-gray-400">
              <p>لا، الأداة تُباع بسعر حصري一次 للوصول مدى الحياة.</p>
            </div>
          </div>
          <div class="faq-item">
            <div class="faq-question">
              <h5 class="font-bold text-white">ما هي تكلفة الاشتراك؟</h5>
              <svg class="faq-icon w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="faq-answer mt-4 text-gray-400">
              <p>لا اشتراك شهري—دفعة واحدة فقط.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Call to Action Section -->
    <section class="py-20 bg-gray-800 text-center">
      <div class="container mx-auto px-4">
        <h3 class="text-4xl font-bold text-white mb-4">جاهز لتحقيق المزيد؟</h3>
        <p class="text-xl text-gray-400 mb-8">انضم إلى فريق العون الذكي وابدأ في إنجاز مهامك بكفاءة غير مسبوقة.</p>
        <a href="#" class="btn-gradient text-white text-lg px-8 py-4 rounded-full">اشترِ الآن</a>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-center py-6">
    <p class="text-gray-500">&copy; 2023 فريق العون الذكي. جميع الحقوق محفوظة.</p>
  </footer>

  <!-- Login Modal -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h4 class="text-2xl font-bold text-white mb-6 text-center">تسجيل الدخول</h4>
      <div class="mb-4">
        <label for="username" class="block text-gray-400 mb-2">اسم المستخدم</label>
        <input type="text" id="username" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-purple-500" placeholder="أدخل اسم المستخدم">
      </div>
      <div class="mb-6">
        <label for="password" class="block text-gray-400 mb-2">كلمة المرور</label>
        <input type="password" id="password" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-purple-500" placeholder="أدخل كلمة المرور">
      </div>
      <button id="submit-login" class="btn-gradient w-full text-white py-3 rounded-full font-bold">دخول</button>
      <p id="login-message" class="mt-4 text-center font-bold"></p>
    </div>
  </div>

  <!-- Setup Chat Interface -->
  <div id="setup-chat-interface" class="hidden fixed top-0 left-0 w-full ه-full bg-[#0d1117] z-[90] flex-col justify-between p-4">
    <div class="flex-grow overflow-y-auto p-4 flex flex-col gap-4" id="setup-chat-messages"></div>
    <div class="flex gap-2 p-2 border-t border-gray-700 chat-input-bar">
      <input type="text" id="setup-chat-input" placeholder="اكتب ردك هنا..." class="flex-grow p-3 rounded-full bg-gray-800 border border-gray-700 text-white focus:outline-none">
      <button id="setup-chat-send-btn" class="bg-blue-600 text-white p-3 rounded-full font-bold">إرسال</button>
    </div>
  </div>

  <!-- Dashboard & Robot Selection -->
  <div id="dashboard-container" class="hidden">
    <header class="p-6 relative z-20">
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-3xl font-bold text-white">لوحة التحكم</h1>
        <div class="flex space-x-4 space-x-reverse">
          <a href="#" id="profile-btn" class="btn-gradient text-white px-6 py-2 rounded-full font-semibold">الملف الشخصي</a>
          <a href="#" id="logout-btn" class="btn-gradient text-white px-6 py-2 rounded-full font-semibold">تسجيل الخروج</a>
        </div>
      </div>
    </header>

    <section class="py-12">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-4xl font-bold mb-4 text-white">اختر مساعدك</h3>
        <p class="text-xl text-gray-400 mb-12 max-w-3xl mx-auto">ابدأ محادثة مع أي مساعد لبدء العمل على مهامك.</p>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6" id="robot-list"></div>
      </div>
    </section>

    <!-- Previous Chats Section -->
    <section class="py-12 bg-gray-900">
      <div class="container mx-auto px-4">
        <h3 class="text-4xl font-bold mb-6 text-white text-center">محادثاتك السابقة</h3>
        <div id="conversations-list" class="space-y-4"></div>
      </div>
    </section>
  </div>

  <!-- Profile Section -->
  <div id="profile-section" class="hidden fixed top-0 left-0 w-full ه-full bg-[#0d1117] z-[90] flex-col p-4 overflow-y-auto">
    <div class="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
      <button id="back-to-dashboard-from-profile-btn" class="text-white text-2xl">&larr;</button>
      <h4 class="text-xl font-bold text-white flex-grow text-center">الملف الشخصي</h4>
      <span class="w-6 h-6"></span>
    </div>
    <div class="container mx-auto px-4 py-8">
      <h3 class="text-3xl font-bold text-white mb-6">بياناتي الأساسية</h3>
      <div id="basic-data" class="bg-gray-800 p-6 rounded-lg mb-8 border border-gray-700"></div>

      <h3 class="text-3xl font-bold text-white mb-6">المعلومات التي تعلمها الذكاء الاصطناعي</h3>
      <div id="learned-data" class="bg-gray-800 p-6 rounded-lg border border-gray-700">
        <p class="text-gray-400">لا توجد معلومات إضافية حتى الآن. ابدأ محادثة مع مساعديك!</p>
      </div>
    </div>
  </div>

  <!-- Robot Chat Interface -->
  <div id="robot-chat-interface" class="hidden fixed top-0 left-0 w-full ه-full bg-[#0d1117] z-[90] flex-col justify-between p-4">
    <div class="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
      <button id="back-to-dashboard-btn" class="text-white text-2xl">&larr;</button>
      <h4 id="robot-chat-header" class="text-xl font-bold text-white flex-grow text-center"></h4>
      <span class="w-6 h-6"></span>
    </div>
    <div id="robot-chat-messages" class="flex-grow overflow-y-auto p-4 flex flex-col gap-4"></div>
    <div class="flex gap-2 p-2 border-top border-gray-700 items-center chat-input-bar">
      <label for="file-upload" class="cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400 hover:text-white">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        <input type="file" id="file-upload" class="hidden">
      </label>
      <input type="text" id="robot-chat-input" placeholder="اكتب رسالتك هنا..." class="flex-grow p-3 rounded-full bg-gray-800 border border-gray-700 text-white focus:outline-none">
      <button id="robot-chat-send-btn" class="bg-blue-600 text-white p-3 rounded-full font-bold">إرسال</button>
    </div>
  </div>

  <!-- زر سريع للنزول لآخر الرسائل -->
  <button id="scroll-to-bottom" aria-label="اذهب لآخر الرسائل">⬇️ آخر الرسائل</button>

  <script>
    /* =============== بيانات الروبوتات (صور معبرة + Lazy) =============== */
    const robots = [
      { name: "ألفا (Alfa)",  specialization: "مساعد التسويق الرقمي",
        img: "https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=800&auto=format&fit=crop" },
      { name: "فيزي (Vizi)",  specialization: "مساعد المبيعات",
        img: "https://images.unsplash.com/photo-1551836022-d5d88e9218df?q=80&w=800&auto=format&fit=crop" },
      { name: "كورتكس (Cortex)", specialization: "مساعد مالي",
        img: "https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?q=80&w=800&auto=format&fit=crop" },
      { name: "ليكس (Lex)",  specialization: "مساعد خدمة العملاء",
        img: "https://images.unsplash.com/photo-1525182008055-f88b95ff7980?q=80&w=800&auto=format&fit=crop" },
      { name: "أوكتو (Octo)", specialization: "مساعد العمليات",
        img: "https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?q=80&w=800&auto=format&fit=crop" },
      { name: "مينا (Mina)",  specialization: "مساعد تحليل البيانات",
        img: "https://images.unsplash.com/photo-1556761175-4b46a572b786?q=80&w=800&auto=format&fit=crop" },
      { name: "بولت (Bolt)",  specialization: "مساعد إدارة المشاريع",
        img: "https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=800&auto=format&fit=crop" },
      { name: "ريكس (Rex)",   specialization: "مساعد الإدارة المالية",
        img: "https://images.unsplash.com/photo-1554224154-22dec7ec8818?q=80&w=800&auto=format&fit=crop" },
      { name: "بادي (Buddy)", specialization: "مساعد العلاقات العامة",
        img: "https://images.unsplash.com/photo-1520975922325-24baf8635f3b?q=80&w=800&auto=format&fit=crop" },
      { name: "روفر (Rover)", specialization: "مساعد علاقات العملاء",
        img: "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=800&auto=format&fit=crop" },
      { name: "فالور (Valor)", specialization: "مساعد التجارة الإلكترونية",
        img: "https://images.unsplash.com/photo-1512295767273-ac109ac3acfa?q=80&w=800&auto=format&fit=crop" },
      { name: "زينيث (Zenith)", specialization: "مساعد الابتكار",
        img: "https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=800&auto=format&fit=crop" },
    ];

    const faqItems = document.querySelectorAll('.faq-item');
    faqItems.forEach(item => { item.addEventListener('click', () => item.classList.toggle('active')); });

    // UI elements
    const loginBtn = document.getElementById('login-btn');
    const loginModal = document.getElementById('login-modal');
    const closeModal = document.querySelector('.close-btn');
    const submitLogin = document.getElementById('submit-login');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('login-message');
    const mainContent = document.getElementById('main-content');
    const mainHeader = document.getElementById('main-header');

    // Setup Chat elements
    const setupChatInterface = document.getElementById('setup-chat-interface');
    const setupChatMessages = document.getElementById('setup-chat-messages');
    const setupChatInput = document.getElementById('setup-chat-input');
    const setupChatSendBtn = document.getElementById('setup-chat-send-btn');

    // Dashboard elements
    const dashboardContainer = document.getElementById('dashboard-container');
    const robotListContainer = document.getElementById('robot-list');
    const conversationsListContainer = document.getElementById('conversations-list');
    const profileBtn = document.getElementById('profile-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // Profile elements
    const profileSection = document.getElementById('profile-section');
    const backToDashboardFromProfileBtn = document.getElementById('back-to-dashboard-from-profile-btn');
    const basicDataContainer = document.getElementById('basic-data');
    const learnedDataContainer = document.getElementById('learned-data');

    // Robot Chat elements
    const robotChatInterface = document.getElementById('robot-chat-interface');
    const robotChatHeader = document.getElementById('robot-chat-header');
    const robotChatMessages = document.getElementById('robot-chat-messages');
    const robotChatInput = document.getElementById('robot-chat-input');
    const robotChatSendBtn = document.getElementById('robot-chat-send-btn');
    const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
    const fileUploadInput = document.getElementById('file-upload');

    // Chat conversation states
    let setupChatState = 0;
    let companyData = {};
    let currentRobot = null;
    let robotChatState = {};
    let aiLearnedData = JSON.parse(localStorage.getItem('aiLearnedData')) || {};

    const setupPrompts = [
      { id: 'name', text: "مرحباً بك! أنا مساعد الإعداد الذكي. قبل أن نبدأ، ما هو اسم شركتك؟" },
      { id: 'industry', text: "شكراً. وما هو مجال عمل شركتك الرئيسي؟ (مثلاً: التجارة الإلكترونية، الخدمات المالية، التكنولوجيا)" },
      { id: 'size', text: "فهمت. وكم عدد الموظفين في شركتك؟" },
      { id: 'audience', text: "تمام. من هو جمهوركم المستهدف؟ (مثلاً: أصحاب الأعمال الصغيرة، الشباب، العائلات)" },
      { id: 'goals', text: "رائع. أخيراً، ما هي أهدافك الرئيسية من استخدام أدواتنا؟ (مثلاً: زيادة المبيعات، تحسين خدمة العملاء، التوسع في سوق جديد)" }
    ];

    function addMessage(chatContainer, text, sender) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('chat-message', `${sender}-message`);
      messageElement.textContent = text;
      chatContainer.appendChild(messageElement);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    /* --- Landing Page & Login Logic --- */
    loginBtn.addEventListener('click', (e) => { e.preventDefault(); loginModal.style.display = 'flex'; });
    closeModal.addEventListener('click', () => { loginModal.style.display = 'none'; });
    window.addEventListener('click', (e) => { if (e.target === loginModal) loginModal.style.display = 'none'; });

    submitLogin.addEventListener('click', () => {
      const username = usernameInput.value;
      const password = passwordInput.value;
      if (username === 'Aiagent' && password === '2222') {
        loginMessage.textContent = 'تم تسجيل الدخول بنجاح!'; loginMessage.style.color = '#10b981';
        setTimeout(() => {
          loginModal.style.display = 'none';
          if (localStorage.getItem('companyData')) { showDashboard(); } else { startSetupChat(); }
        }, 1500);
      } else {
        loginMessage.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.'; loginMessage.style.color = '#ef4444';
      }
    });

    /* --- Setup Chat Logic --- */
    function startSetupChat() {
      mainContent.classList.add('hidden');
      mainHeader.classList.add('hidden');
      setupChatInterface.classList.remove('hidden');
      addMessage(setupChatMessages, setupPrompts[setupChatState].text, 'ai');
    }
    setupChatSendBtn.addEventListener('click', handleSetupChatInput);
    setupChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSetupChatInput(); });

    function handleSetupChatInput() {
      const userMessage = setupChatInput.value.trim();
      if (userMessage === '') return;
      addMessage(setupChatMessages, userMessage, 'user');
      const currentPromptId = setupPrompts[setupChatState].id;
      companyData[currentPromptId] = userMessage;
      setupChatInput.value = '';
      setupChatState++;
      setTimeout(() => {
        if (setupChatState < setupPrompts.length) {
          addMessage(setupChatMessages, setupPrompts[setupChatState].text, 'ai');
        } else {
          addMessage(setupChatMessages, "ممتاز! لقد اكتمل ملفك بنجاح. يتم الآن إعداد أدواتك.", 'ai');
          localStorage.setItem('companyData', JSON.stringify(companyData));
          setTimeout(() => {
            addMessage(setupChatMessages, "أهلاً بك في فريق العون الذكي!", 'ai');
            setupChatInterface.classList.add('hidden'); showDashboard();
          }, 2000);
        }
      }, 1000);
    }

    /* --- Dashboard Logic --- */
    function showDashboard() {
      mainContent.classList.add('hidden');
      mainHeader.classList.remove('hidden');
      dashboardContainer.classList.remove('hidden');
      robotListContainer.classList.remove('hidden');
      profileSection.classList.add('hidden');
      renderRobotList(); renderConversationsList();
    }

    function renderRobotList() {
      robotListContainer.innerHTML = '';
      robots.forEach(robot => {
        const card = document.createElement('div');
        card.className = 'robot-card';
        card.dataset.name = robot.name;
        card.innerHTML = `
          <div class="robot-circle">
            <img loading="lazy" src="${robot.img}" alt="أيقونة روبوت ${robot.name}" class="robot-image"/>
          </div>
          <h4 class="font-bold mt-4 text-white">${robot.name}</h4>
          <p class="text-sm text-gray-400 mt-2">${robot.specialization}</p>
        `;
        card.addEventListener('click', () => startRobotChat(robot.name));
        robotListContainer.appendChild(card);
      });
    }

    function renderConversationsList() {
      conversationsListContainer.innerHTML = '';
      robots.forEach(robot => {
        const conversation = JSON.parse(localStorage.getItem(`conversation_${robot.name}`));
        if (conversation && conversation.length > 0) {
          const listItem = document.createElement('div');
          listItem.className = 'bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
          listItem.textContent = `محادثة سابقة مع ${robot.name}`;
          listItem.addEventListener('click', () => startRobotChat(robot.name));
          conversationsListContainer.appendChild(listItem);
        }
      });
    }

    /* --- Profile Logic --- */
    profileBtn.addEventListener('click', (e) => { e.preventDefault(); dashboardContainer.classList.add('hidden'); profileSection.classList.remove('hidden'); updateProfileSection(); });
    backToDashboardFromProfileBtn.addEventListener('click', () => { profileSection.classList.add('hidden'); dashboardContainer.classList.remove('hidden'); });

    function updateProfileSection() {
      const basicData = JSON.parse(localStorage.getItem('companyData')) || {};
      const learnedData = JSON.parse(localStorage.getItem('aiLearnedData')) || {};
      basicDataContainer.innerHTML = `
        <p class="text-gray-300"><b>اسم الشركة:</b> ${basicData.name || 'غير متوفر'}</p>
        <p class="text-gray-300"><b>مجال العمل:</b> ${basicData.industry || 'غير متوفر'}</p>
        <p class="text-gray-300"><b>الأهداف:</b> ${basicData.goals || 'غير متوفر'}</p>
      `;
      learnedDataContainer.innerHTML = '';
      const learnedKeys = Object.keys(learnedData);
      if (learnedKeys.length > 0) {
        learnedKeys.forEach(key => { learnedDataContainer.innerHTML += `<p class="text-gray-300"><b>${key}:</b> ${learnedData[key]}</p>`; });
      } else {
        learnedDataContainer.innerHTML = `<p class="text-gray-400">لا توجد معلومات إضافية حتى الآن. ابدأ محادثة مع مساعديك!</p>`;
      }
    }

    /* --- Robot Chat Seed Prompts (توجيه عبقري مختصر لكل شخصية) --- */
    const robotPrompts = {
      "ألفا (Alfa)": [
        { role: 'ai', text: 'أنا ألفا (تسويق). حدِّد هدف الحملة (مبيعات/وعي/عملاء جدد) + المنتج والجمهور والميزانية والزمن لنصمم مسارًا سريعًا.' },
      ],
      "فيزي (Vizi)": [
        { role: 'ai', text: 'أنا فيزي (مبيعات). أرسل منتجك وسعره وأهم اعتراض يتكرر؛ سأعطيك Playbook مكالمات ورسائل متابعة محسّنة.' },
      ],
      "كورتكس (Cortex)": [
        { role: 'ai', text: 'أنا كورتكس (مالي). اكتب الإيرادات/المصروفات الشهرية والهدف الربحي؛ سأبني لك ميزانية وتتبُّع تدفق نقدي ومؤشرات.' },
      ],
      "ليكس (Lex)": [
        { role: 'ai', text: 'أنا ليكس (خدمة العملاء). صف المشكلة ونوع القناة (واتساب/بريد/هاتف) وزمن الاستجابة؛ سأقترح قوالب وردود وسياسة تصعيد.' },
      ],
      "أوكتو (Octo)": [
        { role: 'ai', text: 'أنا أوكتو (عمليات). ما العملية المرهِقة الآن؟ سأقدّم SOP مختصر + أتمتة بأدوات جاهزة وخطوات تنفيذ.' },
      ],
      "مينا (Mina)": [
        { role: 'ai', text: 'أنا مينا (تحليلات). ما السؤال التجاري؟ أرسل حقول البيانات المتاحة وسأبني أسئلة فرضية ومقاييس Dashboard قابلة للتنفيذ.' },
      ],
      "بولت (Bolt)": [
        { role: 'ai', text: 'أنا بولت (مشاريع). اذكر اسم المشروع والموعد النهائي والموارد؛ سأخرج WBS وخطة أسبوعية ومخاطر وإجراءات تخفيف.' },
      ],
      "ريكس (Rex)": [
        { role: 'ai', text: 'أنا ريكس (إدارة مالية تشغيلية). ما القسم الأعلى تكلفة؟ سأقترح سياسات صرف وبنود خفض ذكية دون التأثير على الجودة.' },
      ],
      "بادي (Buddy)": [
        { role: 'ai', text: 'أنا بادي (علاقات عامة). حدد الرسالة والجمهور والقناة؛ سأبني حزمة محتوى وجدول نشر ونماذج بيان صحفي.' },
      ],
      "روفر (Rover)": [
        { role: 'ai', text: 'أنا روفر (CRM). أعطني شرائحك الحالية وقيمة الطلب؛ سأصمم رحلات تفعيل/احتفاظ وعروض ولاء.' },
      ],
      "فالور (Valor)": [
        { role: 'ai', text: 'أنا فالور (تجارة إلكترونية). أرسل رابط المنتج ونسبة التحويل الحالية؛ سأشخّص الصفحة وأقترح اختبارات A/B.' },
      ],
      "زينيث (Zenith)": [
        { role: 'ai', text: 'أنا زينيث (ابتكار). اذكر الفكرة والسوق المستهدف وأبسط MVP ممكن؛ سأبني Canvas وخطة تحقق سريعة.' },
      ]
    };

    function startRobotChat(robotName) {
      currentRobot = robotName;
      dashboardContainer.classList.add('hidden');
      robotChatInterface.classList.remove('hidden');
      robotChatHeader.textContent = `محادثة مع ${robotName}`;
      robotChatMessages.innerHTML = '';

      const savedConversation = JSON.parse(localStorage.getItem(`conversation_${robotName}`)) || [];
      if (savedConversation.length > 0) {
        savedConversation.forEach(msg => addMessage(robotChatMessages, msg.text, msg.sender));
      } else {
        robotChatState[robotName] = 0;
        if (robotPrompts[robotName] && robotPrompts[robotName].length > 0) {
          addMessage(robotChatMessages, robotPrompts[robotName][0].text, 'ai');
        } else {
          addMessage(robotChatMessages, "عذراً، لا يمكنني بدء المحادثة الآن. يرجى العودة لاحقاً.", 'ai');
        }
      }

      // تمرير لأسفل عند الفتح
      robotChatMessages.scrollTop = robotChatMessages.scrollHeight;
    }

    backToDashboardBtn.addEventListener('click', () => {
      robotChatInterface.classList.add('hidden');
      dashboardContainer.classList.remove('hidden');
      mainHeader.classList.remove('hidden');
      renderConversationsList();
    });

    fileUploadInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        addMessage(robotChatMessages, `تم تحميل الملف: ${file.name}. جاري تحليله...`, 'user');
        setTimeout(() => {
          const aiResponse = `شكراً لك. تم تحليل الملف. ما سؤالك بخصوصه؟`;
          addMessage(robotChatMessages, aiResponse, 'ai');
          const savedConversation = JSON.parse(localStorage.getItem(`conversation_${currentRobot}`)) || [];
          savedConversation.push({ text: `تم رفع ملف: ${file.name}`, sender: 'user' });
          savedConversation.push({ text: aiResponse, sender: 'ai' });
          localStorage.setItem(`conversation_${currentRobot}`, JSON.stringify(savedConversation));
        }, 1200);
      }
    });

    /* ================== Gemini Bridge (مسار نتلايف + سياق أقوى) ================== */
    const NETLIFY_CHAT_ENDPOINT = "/.netlify/functions/chat";
    function currentPersona() { return typeof currentRobot === "string" ? currentRobot : ""; }

    // نعيد آخر 20 رسالة فقط لتخفيف الطلب
    function recentConversationFor(robotName, limit = 20) {
      const conv = JSON.parse(localStorage.getItem(`conversation_${robotName}`) || "[]");
      return conv.slice(-limit).map(m => ({ role: m.sender === "user" ? "user" : "assistant", text: m.text }));
    }

    function withTimeout(promise, ms = 20000) {
      const t = new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), ms));
      return Promise.race([promise, t]);
    }

    // توجيه عبقري: نضيف "intent" تلقائيًا من الرسالة لتقوية الاستجابة (تصنيف بسيط)
    function inferIntent(text) {
      const t = text.toLowerCase();
      if (t.includes('حملة') || t.includes('اعلان') || t.includes('تسويق')) return 'marketing';
      if (t.includes('مبيعات') || t.includes('تحويل') || t.includes('عميل محتمل')) return 'sales';
      if (t.includes('ميزانية') || t.includes('تكلفة') || t.includes('ربح') || t.includes('تدفق')) return 'finance';
      if (t.includes('شكوى') || t.includes('تذكرة') || t.includes('رضا')) return 'support';
      if (t.includes('مشروع') || t.includes('موعد') || t.includes('خطة')) return 'pm';
      if (t.includes('تحليل') || t.includes('بيانات') || t.includes('تقرير')) return 'analytics';
      if (t.includes('وفاء') || t.includes('crm') || t.includes('ولاء')) return 'crm';
      if (t.includes('متجر') || t.includes('سلة') || t.includes('منتج')) return 'ecom';
      if (t.includes('فكرة') || t.includes('mvp') || t.includes('ابتكار')) return 'innovation';
      return 'general';
    }

    async function geminiReply(userText, persona = "") {
      const company = JSON.parse(localStorage.getItem("companyData") || "{}");
      const history = recentConversationFor(currentRobot || persona);
      const body = {
        messages: [...history, { role: "user", text: userText }],
        persona,
        meta: { company, intent: inferIntent(userText) }
      };

      const res = await withTimeout(fetch(NETLIFY_CHAT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      }));

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`HTTP ${res.status} - ${txt}`);
      }
      const data = await res.json();
      return (data && data.text) ? data.text : "لم أستقبل ردًا من النموذج.";
    }
    function addAIMessage(text) { addMessage(robotChatMessages, text, "ai"); }
    /* ======================================================================= */

    // الإرسال
    function handleRobotChatInput() {
      const userMessage = robotChatInput.value.trim();
      if (!currentRobot) { addAIMessage("⚠️ اختر مساعدًا أولًا من لوحة التحكم."); return; }
      if (userMessage === '') return;

      addMessage(robotChatMessages, userMessage, 'user');

      const savedConversation = JSON.parse(localStorage.getItem(`conversation_${currentRobot}`)) || [];
      savedConversation.push({ text: userMessage, sender: 'user' });

      robotChatInput.value = '';

      (async () => {
        try {
          const reply = await geminiReply(userMessage, currentPersona());
          addAIMessage(reply);
          savedConversation.push({ text: reply, sender: 'ai' });
          localStorage.setItem(`conversation_${currentRobot}`, JSON.stringify(savedConversation));
        } catch (err) {
          console.error(err);
          const fallback = `⚠️ تعذّر الاتصال بالذكاء الاصطناعي:\n${err.message}`;
          addAIMessage(fallback);
          savedConversation.push({ text: fallback, sender: 'ai' });
          localStorage.setItem(`conversation_${currentRobot}`, JSON.stringify(savedConversation));
        }
      })();
    }

    robotChatSendBtn.addEventListener('click', handleRobotChatInput);
    robotChatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRobotChatInput(); }
    });

    // Initial check for setup
    document.addEventListener('DOMContentLoaded', () => {
      // بناء بطاقات الروبوتات على الصفحة الرئيسية أيضاً (قسم "تعرف على فريقك")
      const robotsGrid = document.getElementById('robots-grid');
      if (robotsGrid) {
        robots.forEach(robot => {
          const div = document.createElement('div');
          div.className = 'robot-card p-4';
          div.innerHTML = `
            <div class="robot-circle"><img loading="lazy" src="${robot.img}" alt="أيقونة روبوت ${robot.name}" class="robot-image"/></div>
            <h4 class="font-bold mt-4 text-white">${robot.name}</h4>
            <p class="text-sm text-gray-400 mt-2"><b>${robot.specialization}:</b> جاهز للمساعدة الآن.</p>
          `;
          robotsGrid.appendChild(div);
        });
      }

      if (localStorage.getItem('companyData')) {
        mainContent.classList.add('hidden');
        mainHeader.classList.remove('hidden');
        dashboardContainer.classList.remove('hidden');
        renderRobotList();
        renderConversationsList();
      }
    });

    /* ====== إصلاحات الموبايل: vh + لوحة المفاتيح + زر آخر الرسائل ====== */
    function setVH() {
      const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight) * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);
    if (window.visualViewport) window.visualViewport.addEventListener('resize', setVH);

    (function fixKeyboardOverlap() {
      if (!window.visualViewport) return;
      const bars = document.querySelectorAll('.chat-input-bar');
      function sync() {
        const bottom = Math.max(0, (window.innerHeight - window.visualViewport.height - window.visualViewport.offsetTop));
        bars.forEach(el => { el.style.marginBottom = bottom ? `${bottom}px` : ''; });
      }
      window.visualViewport.addEventListener('resize', sync);
      window.visualViewport.addEventListener('scroll', sync);
      sync();
    })();

    (function smartScroll() {
      const btn = document.getElementById('scroll-to-bottom');
      const containers = [document.getElementById('robot-chat-messages'), document.getElementById('setup-chat-messages')].filter(Boolean);
      function isNearBottom(el, px = 120) {
        return (el.scrollHeight - el.scrollTop - el.clientHeight) < px;
      }
      function scrollToBottom(el) { el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' }); }
      function refreshButtonVisibility() {
        const active = containers.find(el => el && el.offsetParent !== null);
        if (!active) return;
        btn.classList.toggle('show', !isNearBottom(active));
      }
      containers.forEach(el => el.addEventListener('scroll', refreshButtonVisibility, { passive: true }));
      btn.addEventListener('click', () => {
        const active = containers.find(el => el && el.offsetParent !== null);
        if (active) scrollToBottom(active);
      });
      const _addMessage = addMessage;
      window.addMessage = function(chatContainer, text, sender) {
        const stick = isNearBottom(chatContainer);
        _addMessage(chatContainer, text, sender);
        if (stick) chatContainer.scrollTop = chatContainer.scrollHeight; else refreshButtonVisibility();
      };
      document.addEventListener('DOMContentLoaded', () => containers.forEach(c => c && (c.scrollTop = c.scrollHeight)));
    })();
  </script>

  <!-- =========================
       إضافات: سلوك التمرير الذكي (لا يحذف شيء - مجرد طبقة فوقية)
       ========================= -->
  <script>
    (function enhanceChatScrollBehavior(){
      const BOT = {
        containers: []
      };
      const robotChatMessagesEl = document.getElementById('robot-chat-messages');
      const setupChatMessagesEl = document.getElementById('setup-chat-messages');
      const scrollBtn = document.getElementById('scroll-to-bottom');

      if (robotChatMessagesEl) BOT.containers.push(robotChatMessagesEl);
      if (setupChatMessagesEl) BOT.containers.push(setupChatMessagesEl);

      // Helper: هل المستخدم يتصفح لأعلى (يعني لا نرغم على scroll to bottom)
      function isUserAtBottom(container, threshold = 120) {
        return (container.scrollHeight - container.scrollTop - container.clientHeight) < threshold;
      }

      // Auto-scroll فقط إذا المستخدم في الأسفل
      function maybeAutoScroll(container) {
        if (!container) return;
        if (isUserAtBottom(container, 120)) {
          container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }
      }

      // مراقب تغيّر DOM: عند إضافة رسالة جديدة، نفعل auto-scroll بشرط
      function watchContainer(container) {
        if (!container) return;
        // نستخدم MutationObserver لمراقبة الرسائل المضافة
        const mo = new MutationObserver((mutations) => {
          // لو أضافت عناصر جديدة
          const added = mutations.some(m => m.addedNodes && m.addedNodes.length);
          if (!added) return;
          // لا نزعج المستخدم إن كان يتصفح لأعلى
          if (isUserAtBottom(container, 120)) {
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
          } else {
            // إظهار زر العودة لآخر الرسائل
            updateScrollButtonVisibility(container);
          }
        });
        mo.observe(container, { childList: true, subtree: false });
      }

      // دعم اللمس / السحب (بعض البيئات قد لا تحتاجها لكن نحسّن التفاعل)
      function enableTouchScroll(container) {
        if (!container) return;
        let startY = 0, startScroll = 0;
        container.addEventListener('touchstart', (e) => {
          if (e.touches && e.touches.length) {
            startY = e.touches[0].pageY;
            startScroll = container.scrollTop;
          }
        }, { passive: true });

        container.addEventListener('touchmove', (e) => {
          if (!(e.touches && e.touches.length)) return;
          const dy = e.touches[0].pageY - startY;
          // نطبق التحريك اليدوي على الscrollTop
          container.scrollTop = startScroll - dy;
        }, { passive: true });
      }

      // تحديث ظهور زر "آخر الرسائل"
      function updateScrollButtonVisibility(activeContainer) {
        if (!scrollBtn) return;
        const show = !isUserAtBottom(activeContainer, 150);
        if (show) {
          scrollBtn.classList.add('show');
        } else {
          scrollBtn.classList.remove('show');
        }
      }

      // ربط الأحداث على كل Container
      BOT.containers.forEach(c => {
        // Scroll listener — إظهار/إخفاء الزر حسب الموقع
        c.addEventListener('scroll', () => {
          // اختر الcontainer الظاهر حالياً (الذي ليس مخفي)
          const active = BOT.containers.find(el => el && el.offsetParent !== null) || c;
          updateScrollButtonVisibility(active);
        }, { passive: true });

        // enable touch / drag scroll
        enableTouchScroll(c);

        // mutation observer
        watchContainer(c);
      });

      // زر العودة لآخر الرسائل: يحدد العنصر الظاهر ويقوم بالتمرير
      if (scrollBtn) {
        scrollBtn.addEventListener('click', () => {
          const active = BOT.containers.find(el => el && el.offsetParent !== null);
          if (active) {
            active.scrollTo({ top: active.scrollHeight, behavior: 'smooth' });
            scrollBtn.classList.remove('show');
          }
        });
      }

      // عندما يركز المستخدم على الحقل لإدخال رسالة، ننزل لآخر الرسائل (مثل واتساب)
      if (robotChatInput) {
        robotChatInput.addEventListener('focus', () => {
          const active = document.getElementById('robot-chat-messages');
          if (active) active.scrollTo({ top: active.scrollHeight, behavior: 'smooth' });
        });
      }
      if (setupChatInput) {
        setupChatInput.addEventListener('focus', () => {
          const active = document.getElementById('setup-chat-messages');
          if (active) active.scrollTo({ top: active.scrollHeight, behavior: 'smooth' });
        });
      }

      // إذا كانت هناك رسائل محفوظة عند الفتح، انزل لأسفل
      document.addEventListener('DOMContentLoaded', () => {
        BOT.containers.forEach(c => { try { c.scrollTop = c.scrollHeight; } catch(e){} });
      });

      // expose small API إن احتجت
      window._chatEnhance = {
        maybeAutoScroll,
        isUserAtBottom,
        updateScrollButtonVisibility
      };
    })();
  </script>

  <script src="auth-bridge-global.js"></script>
</body>
</html>
