<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>فريق العون الذكي</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    :root { --vh: 1vh; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Cairo', sans-serif; background:#0d1117; color:#e5e7eb; line-height:1.6; display:flex; flex-direction:column; height:100vh; height:100dvh; }
    h1,h2,h3,h4,h5,h6 { font-family:'Tajawal',sans-serif; margin-bottom:1rem; }
    p { margin-bottom: 1.5rem; }
    .text-gradient { background:linear-gradient(90deg,#60a5fa,#8b5cf6,#ec4899); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
    .btn-gradient { background:linear-gradient(90deg,#60a5fa,#8b5cf6); transition:transform .3s, box-shadow .3s; box-shadow:0 4px 10px rgba(0,0,0,.2); position:relative; z-index:10; }
    .btn-gradient:hover { transform:translateY(-5px); box-shadow:0 10px 20px rgba(0,0,0,.3); }
    #main-header,#dashboard-header{position:sticky;top:0;z-index:50;background:rgba(13,17,23,.85); backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid #30363d;}
    #scroll-wrapper{flex-grow:1;overflow-y:auto;}
    #main-footer{position:sticky;bottom:0;z-index:50;background:#0d1117;border-top:1px solid #30363d;}
    .hero-section{background:url('https://images.unsplash.com/photo-1516117172878-fd2dc7981503?q=80&w=2070&auto=format&fit=crop') no-repeat center/cover; position:relative; padding:8rem 0; overflow:hidden;}
    .hero-overlay{position:absolute; inset:0; background:rgba(13,17,23,.8);}
    .card{background:#161b22;border:1px solid #30363d;transition:transform .3s,box-shadow .3s; box-shadow:0 4px 8px rgba(0,0,0,.2);}
    .card:hover{transform:translateY(-10px); box-shadow:0 15px 25px rgba(0,0,0,.4); background:#1f242b;}
    .robot-card{display:flex;flex-direction:column;align-items:center;text-align:center;background:#161b22;padding:1.5rem;border-radius:1rem;border:1px solid #30363d; box-shadow:0 4px 8px rgba(0,0,0,.2); transition:transform .3s; position:relative; overflow:hidden; cursor:pointer;}
    .robot-card:hover{transform:translateY(-10px);}
    .robot-circle{width:120px;height:120px;border-radius:50%;background:linear-gradient(to right,#60a5fa,#8b5cf6); display:flex;justify-content:center;align-items:center;position:relative;overflow:hidden;}
    .robot-image{width:100%;height:100%;object-fit:cover;transition:transform .3s;}
    .robot-card:hover .robot-image{transform:scale(1.1);}
    .faq-item{background:#161b22;padding:1.5rem;border-radius:.75rem;border:1px solid #30363d;cursor:pointer;transition:background-color .3s;}
    .faq-item:hover{background:#1f242b;}
    .faq-question{display:flex;justify-content:space-between;align-items:center;}
    .faq-answer{max-height:0;overflow:hidden;transition:max-height .5s ease-in-out;}
    .faq-item.active .faq-answer{max-height:200px;padding-top:1rem;}
    .faq-icon{transform:rotate(0);transition:transform .3s;}
    .faq-item.active .faq-icon{transform:rotate(180deg);}
    .discount-badge{background:linear-gradient(90deg,#60a5fa,#8b5cf6,#ec4899);color:#fff;padding:.5rem 1.5rem;border-radius:9999px;font-weight:bold;font-size:1.125rem; position:absolute;top:-1.5rem;right:-1.5rem;transform:rotate(45deg);transform-origin:bottom left;box-shadow:0 4px 10px rgba(0,0,0,.2);}
    .modal{display:none;position:fixed;z-index:100;inset:0;overflow:auto;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);justify-content:center;align-items:center;}
    .modal-content{background:#161b22;padding:2rem;border:1px solid #30363d;width:90%;max-width:400px;border-radius:1rem;box-shadow:0 10px 25px rgba(0,0,0,.5);animation:fadeIn .3s;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
    .close-btn{color:#aaa;float:left;font-size:28px;font-weight:bold;}
    .close-btn:hover,.close-btn:focus{color:#fff;text-decoration:none;cursor:pointer;}
    .chat-message{padding:.75rem 1rem;border-radius:.75rem;max-width:85%;word-break:break-word;white-space:pre-wrap;position:relative;box-shadow:0 1px 2px rgba(0,0,0,.2);}
    .user-message{background:#056056;color:#fff;align-self:flex-end;text-align:right;border-bottom-right-radius:.25rem;}
    .ai-message{background:#202c33;color:#fff;align-self:flex-start;text-align:left;border-bottom-left-radius:.25rem;}
    #robot-chat-messages,#setup-chat-messages{-webkit-overflow-scrolling:touch;scroll-behavior:smooth;overscroll-behavior:contain;padding-bottom:88px;}
    #robot-chat-interface,#setup-chat-interface{display:none;position:fixed;inset:0;background:#0d1117;z-index:90;flex-direction:column;justify-content:space-between; height:100vh;height:100dvh;height:calc(var(--vh)*100); padding-bottom:env(safe-area-inset-bottom,0px);}
    .chat-input-bar{position:sticky;bottom:0;left:0;right:0;background:rgba(13,17,23,.9);backdrop-filter:blur(6px);border-top:1px solid #30363d;z-index:5;padding:.5rem;}
    #scroll-to-bottom{position:fixed;inset-inline-end:1rem;inset-block-end:calc(6rem + env(safe-area-inset-bottom,0px)); background:#8b5cf6;color:#fff;border-radius:9999px;padding:.6rem 1rem;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35); display:none;z-index:60;border:1px solid rgba(255,255,255,.2);}
    #scroll-to-bottom.show{display:inline-flex;align-items:center;gap:.5rem;}
  </style>
</head>
<body class="antialiased">
  <!-- … [كل الأقسام كما هي تماماً دون أي تعديل بصري] … -->

  <!-- إبقاء كل HTML كما هو — بداية تعديلات المنطق داخل السكربت فقط -->
  <script>
    /* ===== بيانات الروبوتات (بدون تعديل) ===== */
    const robots = [
      { name:"ألفا (Alfa)", specialization:"مساعد التسويق الرقمي", img:"https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=800&auto=format&fit=crop" },
      { name:"فيزي (Vizi)", specialization:"مساعد المبيعات", img:"https://images.unsplash.com/photo-1551836022-d5d88e9218df?q=80&w=800&auto=format&fit=crop" },
      { name:"كورتكس (Cortex)", specialization:"مساعد مالي", img:"https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?q=80&w=800&auto=format&fit=crop" },
      { name:"ليكس (Lex)", specialization:"مساعد خدمة العملاء", img:"https://images.unsplash.com/photo-1525182008055-f88b95ff7980?q=80&w=800&auto=format&fit=crop" },
      { name:"أوكتو (Octo)", specialization:"مساعد العمليات", img:"https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?q=80&w=800&auto=format&fit=crop" },
      { name:"مينا (Mina)", specialization:"مساعد تحليل البيانات", img:"https://images.unsplash.com/photo-1556761175-4b46a572b786?q=80&w=800&auto=format&fit=crop" },
      { name:"بولت (Bolt)", specialization:"مساعد إدارة المشاريع", img:"https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=800&auto=format&fit=crop" },
      { name:"ريكس (Rex)", specialization:"مساعد الإدارة المالية", img:"https://images.unsplash.com/photo-1554224154-22dec7ec8818?q=80&w=800&auto=format&fit=crop" },
      { name:"بادي (Buddy)", specialization:"مساعد العلاقات العامة", img:"https://images.unsplash.com/photo-1520975922325-24baf8635f3b?q=80&w=800&auto=format&fit=crop" },
      { name:"روفر (Rover)", specialization:"مساعد علاقات العملاء", img:"https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=800&auto=format&fit=crop" },
      { name:"فالور (Valor)", specialization:"مساعد التجارة الإلكترونية", img:"https://images.unsplash.com/photo-1512295767273-ac109ac3acfa?q=80&w=800&auto=format&fit=crop" },
      { name:"زينيث (Zenith)", specialization:"مساعد الابتكار", img:"https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=800&auto=format&fit=crop" },
    ];

    /* … [كل عناصر DOM كما هي] … */

    /* حالات */
    let setupChatState = 0;
    let companyData = {};
    let currentRobot = null;
    let robotChatState = {};
    let aiLearnedData = JSON.parse(localStorage.getItem('aiLearnedData')) || {};

    /* دوال واجهة الرسائل */
    function addMessage(chatContainer, text, sender) {
      const el = document.createElement('div');
      el.classList.add('chat-message', `${sender}-message`);
      el.textContent = text;
      chatContainer.appendChild(el);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    window.addMessage = addMessage;
    function currentPersona(){ return typeof currentRobot === 'string' ? currentRobot : ''; }
    window.currentPersona = currentPersona;

    /* … [الدوال والـ listeners كما هي، دون تغيير بصري] … */

    /* ======= Gemini Bridge (Netlify Function) ======= */
    const NETLIFY_CHAT_ENDPOINT = "/.netlify/functions/chat";

    function recentConversationFor(robotName, limit=50){ // كان 20 → الآن 50
      const conv = JSON.parse(localStorage.getItem(`conversation_${robotName}`)||'[]');
      return conv.slice(-limit).map(m=>({role:m.sender==='user'?'user':'assistant', text:m.text}));
    }
    window.recentConversationFor = recentConversationFor;

    function withTimeout(p, ms=45000){ // كان 20000 → الآن 45000
      const t = new Promise((_,rej)=> setTimeout(()=> rej(new Error('timeout')), ms));
      return Promise.race([p,t]);
    }

    function inferIntent(text){
      const t=(text||'').toLowerCase();
      if(t.includes('حملة')||t.includes('اعلان')||t.includes('تسويق')) return 'marketing';
      if(t.includes('مبيعات')||t.includes('تحويل')||t.includes('عميل')||t.includes('صفقة')||t.includes('اغلاق')) return 'sales';
      if(t.includes('ميزانية')||t.includes('تكلفة')||t.includes('ربح')||t.includes('تدفق')||t.includes('محاسبة')||t.includes('استثمار')) return 'finance';
      if(t.includes('شكوى')||t.includes('تذكرة')||t.includes('رضا')||t.includes('دعم')) return 'support';
      if(t.includes('مشروع')||t.includes('موعد')||t.includes('خطة')||t.includes('نطاق')||t.includes('مخاطر')) return 'pm';
      if(t.includes('تحليل')||t.includes('بيانات')||t.includes('تقرير')||t.includes('لوحة')||t.includes('dashboard')) return 'analytics';
      if(t.includes('ولاء')||t.includes('crm')||t.includes('احتفاظ')||t.includes('تفعيل')) return 'crm';
      if(t.includes('متجر')||t.includes('سلة')||t.includes('منتج')||t.includes('تحويل')||t.includes('checkout')) return 'ecom';
      if(t.includes('فكرة')||t.includes('mvp')||t.includes('ابتكار')||t.includes('اختبار')) return 'innovation';
      return 'general';
    }
    window.inferIntent = inferIntent;

    async function geminiReply(userText, persona=''){
      const company = JSON.parse(localStorage.getItem('companyData')||'{}');
      const history = recentConversationFor(currentPersona()||persona, 50);
      const langDom = (document.documentElement.lang||'').slice(0,2).toLowerCase();
      const lang = (langDom==='ar'||langDom==='en') ? langDom : ((navigator.language||'ar').slice(0,2).toLowerCase());

      const body = { messages:[...history,{role:'user',text:userText}], persona, company, meta:{ intent: inferIntent(userText), lang } };

      const res = await withTimeout(fetch(NETLIFY_CHAT_ENDPOINT, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      }), 45000);

      if(!res.ok){ throw new Error(`HTTP ${res.status} - ${await res.text()}`); }
      const data = await res.json();
      return (data && data.text) ? data.text : (lang==='ar' ? 'لم أستقبل ردًا من النموذج.' : 'No response from the model.');
    }
    window.geminiReply = geminiReply;

    function addAIMessage(text){ addMessage(robotChatMessages, text, 'ai'); }

    function handleRobotChatInput(){
      const userMessage = robotChatInput.value.trim();
      if(!currentRobot){ addAIMessage('⚠️ اختر مساعدًا أولًا من لوحة التحكم.'); return; }
      if(!userMessage) return;
      addMessage(robotChatMessages, userMessage, 'user');

      const saved = JSON.parse(localStorage.getItem(`conversation_${currentRobot}`)||'[]');
      saved.push({text:userMessage, sender:'user'});
      robotChatInput.value='';

      (async()=>{
        try{
          const reply = await geminiReply(userMessage, currentPersona());
          addAIMessage(reply);
          saved.push({text:reply, sender:'ai'});
          localStorage.setItem(`conversation_${currentRobot}`, JSON.stringify(saved));
        }catch(err){
          console.error(err);
          const fallback = `⚠️ تعذّر الاتصال بالذكاء الاصطناعي:\n${err.message}\n\n- جرّب إعادة الصياغة أو أعد المحاولة بعد لحظات.`;
          addAIMessage(fallback);
          saved.push({text:fallback, sender:'ai'});
          localStorage.setItem(`conversation_${currentRobot}`, JSON.stringify(saved));
        }
      })();
    }

    robotChatSendBtn.addEventListener('click', handleRobotChatInput);
    robotChatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleRobotChatInput(); } });

    // … [باقي السكربت كما هو دون تعديل بصري]
  </script>

  <!-- Patch (كما هو) -->
  <script src="auth-bridge-global.js"></script>
</body>
</html>
