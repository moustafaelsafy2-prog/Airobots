<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>فريق العون الذكي</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --vh: 1vh;
    }
    html, body {
      overscroll-behavior-y: contain;
      height: 100%;
    }
    body {
      font-family: 'Cairo', sans-serif;
      background: #0d1117;
      color: #e5e7eb;
      line-height: 1.6;
    }
    h1,h2,h3,h4,h5,h6 {
      font-family: 'Tajawal', sans-serif;
      margin-bottom: 1rem;
    }
    p { margin-bottom: 1.5rem; }
    .text-gradient {
      background: linear-gradient(90deg, #60a5fa, #8b5cf6, #ec4899);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .btn-gradient {
      background: linear-gradient(90deg, #60a5fa, #8b5cf6);
      transition: transform .3s, box-shadow .3s;
      box-shadow: 0 4px 10px rgba(0,0,0,.2);
    }
    .btn-gradient:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,.3);
    }
    .card {
      background-color: #161b22;
      border: 1px solid #30363d;
      transition: transform .3s, box-shadow .3s;
      box-shadow: 0 4px 8px rgba(0,0,0,.2);
    }
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 25px rgba(0,0,0,.4);
      background-color: #1f242b;
    }
    .faq-item {
      background:#161b22;
      padding:1.5rem;
      border-radius:.75rem;
      border:1px solid #30363d;
      cursor:pointer;
      transition:background-color .3s;
    }
    .faq-item:hover { background:#1f242b; }
    .faq-question { display:flex; justify-content:space-between; align-items:center; }
    .faq-answer { max-height:0; overflow:hidden; transition:max-height .5s ease-in-out; }
    .faq-item.active .faq-answer { max-height:200px; }
    .faq-icon { transform:rotate(0); transition:transform .3s; }
    .faq-item.active .faq-icon { transform:rotate(180deg); }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      inset: 0;
      overflow: auto;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #161b22;
      padding: 2rem;
      border: 1px solid #30363d;
      width: 90%;
      max-width: 400px;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,.5);
      animation: fadeIn .3s;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(-20px); }
      to { opacity:1; transform:translateY(0); }
    }
    .close-btn {
      color:#aaa;
      position: absolute;
      top: 1rem;
      left: 1rem; /* Adjusted for RTL */
      font-size:28px;
      font-weight:bold;
    }
    .close-btn:hover, .close-btn:focus {
      color:#fff;
      text-decoration:none;
      cursor:pointer;
    }

    /* App Layout & Chat Interfaces */
    .app-view {
      display: none;
      height: 100dvh;
      height: calc(var(--vh) * 100);
      flex-direction: column;
      background-color: #0d1117;
    }
    .app-view.active {
      display: flex;
    }
    .app-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(13, 17, 23, 0.8);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #30363d;
    }
    .app-content {
      flex-grow: 1;
      overflow-y: auto;
    }

    /* Chat-specific styles */
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding-bottom: 88px; /* Space for input bar */
    }
    .chat-message {
      padding: .75rem 1rem;
      border-radius: .75rem;
      max-width: 80%;
      word-break: break-word;
      white-space: pre-wrap;
      animation: messageFadeIn 0.3s ease-out;
    }
     @keyframes messageFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .user-message {
      background: #2563eb;
      color: #fff;
      align-self: flex-end;
      text-align: right;
      border-bottom-right-radius: 0;
    }
    .ai-message {
      background: #374151;
      color: #fff;
      align-self: flex-start;
      text-align: left;
      border-bottom-left-radius: 0;
    }
    .chat-input-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(22, 27, 34, .9);
      backdrop-filter: blur(6px);
      border-top: 1px solid #30363d;
      z-index: 60;
      padding-bottom: max(env(safe-area-inset-bottom, 0px), 0px);
    }
    .chat-input {
      flex-grow: 1;
      background: #161b22;
      border: 1px solid #30363d;
      padding: .75rem 1.25rem;
      border-radius: 9999px;
      color: #fff;
      resize: none; /* For textarea */
    }
    .chat-send-btn {
      background: #2563eb;
      color: #fff;
      padding: .75rem;
      border-radius: 9999px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color .3s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
    }
    .chat-send-btn:hover { background: #1d4ed8; }

    /* Robot Cards */
    .robot-card {
      display:flex; flex-direction:column; align-items:center; text-align:center;
      background:#161b22; padding:1.5rem; border-radius:1rem;
      border:1px solid #30363d; box-shadow:0 4px 8px rgba(0,0,0,.2);
      transition:transform .3s; position:relative; overflow:hidden; cursor:pointer;
    }
    .robot-card:hover { transform: translateY(-10px); }
    .robot-circle {
      width:120px; height:120px; border-radius:50%;
      background:linear-gradient(to right, #60a5fa, #8b5cf6);
      display:flex; justify-content:center; align-items:center; position:relative; overflow:hidden;
    }
    .robot-image { width:100%; height:100%; object-fit:cover; transition:transform .3s; }
    .robot-card:hover .robot-image { transform:scale(1.1); }

    /* Scroll to bottom button */
    #scroll-to-bottom {
      position: fixed;
      inset-inline-end: 1rem;
      inset-block-end: calc(6rem + env(safe-area-inset-bottom, 0px));
      background: #8b5cf6;
      color: #fff;
      border-radius: 9999px;
      padding: .6rem 1rem;
      font-weight: 700;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      display: none;
      z-index: 70;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    #scroll-to-bottom.show {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="antialiased">

  <!-- Landing Page View -->
  <div id="landing-view" class="app-view active">
    <header class="app-header p-6">
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-3xl font-bold text-white">فريق العون الذكي</h1>
        <a href="#" id="login-btn" class="btn-gradient text-white px-6 py-2 rounded-full font-semibold">تسجيل الدخول</a>
      </div>
    </header>
    <main class="app-content">
      <section class="hero-section text-center relative flex items-center justify-center py-20" style="background: url('https://images.unsplash.com/photo-1516117172878-fd2dc7981503?q=80&w=2070&auto=format&fit=crop') no-repeat center center/cover;">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="container mx-auto px-4 relative z-10 py-16">
          <h2 class="text-5xl md:text-7xl font-extrabold leading-tight mb-4 text-white">
            <span class="text-gradient">أنجز أكثر</span> مع فريق العون الذكي
          </h2>
          <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-3xl mx-auto">
            نقدم لك فريقاً متخصصاً من 12 مساعداً، كل منهم جاهز لإنجاز مهمة محددة بدقة وكفاءة.
          </p>
          <a href="#" class="btn-gradient text-white text-lg px-8 py-4 rounded-full">ابدأ الآن</a>
        </div>
      </section>
      <!-- Other landing page sections -->
      <section class="py-20 bg-gray-900 text-center">
        <div class="container mx-auto px-4">
          <h3 class="text-4xl font-bold mb-4 text-white">عرض حصري مدى الحياة</h3>
          <p class="text-xl text-gray-400 mb-8 max-w-2xl mx-auto">
            احصل على وصول كامل وغير محدود إلى جميع المساعدين بسعر استثنائي يدفع لمرة واحدة.
          </p>
          <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 max-w-lg mx-auto relative overflow-hidden">
            <div class="absolute top-0 right-0 text-white font-bold bg-gradient-to-r from-purple-600 to-pink-500 px-10 py-2 transform translate-x-1/2 -translate-y-1/2 rotate-45">خصم ٩٠%</div>
            <div class="relative z-10 flex flex-col items-center">
              <p class="text-5xl font-extrabold text-white mb-2">
                <span class="text-2xl line-through text-gray-500">200$</span>
                <span class="text-gradient text-6xl">39$</span>
              </p>
              <p class="text-gray-400 mb-6">للوصول مدى الحياة</p>
              <a href="#" class="btn-gradient text-white text-lg px-8 py-4 rounded-full">اشترِ الآن</a>
            </div>
          </div>
        </div>
      </section>

      <section class="py-20">
          <div class="container mx-auto px-4 text-center">
              <h3 class="text-4xl font-bold mb-12 text-white">تعرف على فريقك</h3>
              <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6" id="robots-grid-landing">
                  <!-- Robot cards will be populated here by JavaScript -->
              </div>
          </div>
      </section>
      
      <section class="py-20 bg-gray-900">
        <div class="container mx-auto px-4 text-center">
            <h3 class="text-4xl font-bold mb-12 text-white">الأسئلة الشائعة</h3>
            <div class="space-y-4 max-w-3xl mx-auto text-right">
                <div class="faq-item">
                    <div class="faq-question">
                        <h5 class="font-bold text-white">هل يمكنني استخدام أكثر من مساعد في نفس الوقت؟</h5>
                        <svg class="faq-icon w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="faq-answer mt-4 text-gray-400">
                        <p>نعم، يمكنك استخدام أي عدد من المساعدين بالتوازي—كل مساعد يعمل بشكل مستقل.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h5 class="font-bold text-white">هل تتوفر نسخة تجريبية مجانية؟</h5>
                        <svg class="faq-icon w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="faq-answer mt-4 text-gray-400">
                        <p>لا، الأداة تُباع بسعر حصري لمرة واحدة للوصول مدى الحياة.</p>
                    </div>
                </div>
                 <div class="faq-item">
                    <div class="faq-question">
                        <h5 class="font-bold text-white">ما هي تكلفة الاشتراك؟</h5>
                        <svg class="faq-icon w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="faq-answer mt-4 text-gray-400">
                        <p>لا يوجد اشتراك شهري—دفعة واحدة فقط للوصول الكامل مدى الحياة.</p>
                    </div>
                </div>
            </div>
        </div>
      </section>
      <footer class="bg-gray-900/50 text-center py-6">
        <p class="text-gray-500">&copy; 2024 فريق العون الذكي. جميع الحقوق محفوظة.</p>
      </footer>
    </main>
  </div>
  
  <!-- Setup Chat View -->
  <div id="setup-chat-view" class="app-view">
      <header class="app-header p-4 text-center">
          <h2 class="text-xl font-bold text-white">إعداد حسابك</h2>
      </header>
      <div id="setup-chat-messages" class="chat-messages"></div>
      <div class="chat-input-bar p-2 flex gap-2 items-center">
          <textarea id="setup-chat-input" placeholder="اكتب ردك هنا..." class="chat-input" rows="1"></textarea>
          <button id="setup-chat-send-btn" class="chat-send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
          </button>
      </div>
  </div>

  <!-- Dashboard View -->
  <div id="dashboard-view" class="app-view">
    <header class="app-header p-4">
      <div class="container mx-auto flex justify-between items-center">
          <h1 class="text-2xl font-bold text-white">لوحة التحكم</h1>
          <div class="flex space-x-2 space-x-reverse">
              <button id="profile-btn" class="btn-gradient text-white px-4 py-2 rounded-full font-semibold">ملفي</button>
              <button id="logout-btn" class="bg-gray-700 text-white px-4 py-2 rounded-full font-semibold hover:bg-gray-600">خروج</button>
          </div>
      </div>
    </header>
    <main class="app-content">
        <section class="py-12">
            <div class="container mx-auto px-4 text-center">
                <h3 class="text-3xl font-bold mb-4 text-white">اختر مساعدك</h3>
                <p class="text-lg text-gray-400 mb-10 max-w-3xl mx-auto">ابدأ محادثة مع أي مساعد لبدء العمل على مهامك.</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6" id="robot-list-dashboard"></div>
            </div>
        </section>
        <section class="py-12 bg-gray-900/50">
            <div class="container mx-auto px-4">
                <h3 class="text-3xl font-bold mb-6 text-white text-center">محادثاتك السابقة</h3>
                <div id="conversations-list" class="space-y-4 max-w-3xl mx-auto">
                    <!-- Previous chats will be listed here -->
                </div>
            </div>
        </section>
    </main>
  </div>

  <!-- Profile View -->
  <div id="profile-view" class="app-view">
      <header class="app-header p-4 flex items-center justify-between">
          <button id="back-to-dashboard-from-profile-btn" class="text-white text-2xl p-2">&rarr;</button>
          <h2 class="text-xl font-bold text-white flex-grow text-center">الملف الشخصي</h2>
          <span class="w-10"></span>
      </header>
      <main class="app-content p-4">
          <div class="container mx-auto py-8">
              <h3 class="text-2xl font-bold text-white mb-4">بياناتي الأساسية</h3>
              <div id="basic-data" class="bg-gray-800 p-6 rounded-lg mb-8 border border-gray-700"></div>

              <h3 class="text-2xl font-bold text-white mb-4">المعلومات المكتسبة</h3>
              <div id="learned-data" class="bg-gray-800 p-6 rounded-lg border border-gray-700"></div>
          </div>
      </main>
  </div>

  <!-- Robot Chat View -->
  <div id="robot-chat-view" class="app-view">
      <header class="app-header p-4 flex items-center justify-between">
          <button id="back-to-dashboard-btn" class="text-white text-2xl p-2">&rarr;</button>
          <h2 id="robot-chat-header" class="text-xl font-bold text-white flex-grow text-center"></h2>
          <span class="w-10"></span>
      </header>
      <div id="robot-chat-messages" class="chat-messages"></div>
      <div class="chat-input-bar p-2 flex gap-2 items-center">
          <label for="file-upload" class="cursor-pointer p-2 text-gray-400 hover:text-white">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" /></svg>
              <input type="file" id="file-upload" class="hidden">
          </label>
          <textarea id="robot-chat-input" placeholder="اكتب رسالتك هنا..." class="chat-input" rows="1"></textarea>
          <button id="robot-chat-send-btn" class="chat-send-btn">
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
          </button>
      </div>
  </div>

  <!-- Global Elements -->
  <button id="scroll-to-bottom" aria-label="اذهب لآخر الرسائل">⬇️ آخر الرسائل</button>

  <div id="login-modal" class="modal">
    <div class="modal-content relative">
      <span class="close-btn">&times;</span>
      <h4 class="text-2xl font-bold text-white mb-6 text-center">تسجيل الدخول</h4>
      <div class="mb-4">
        <label for="username" class="block text-gray-400 mb-2">اسم المستخدم</label>
        <input type="text" id="username" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-purple-500" placeholder="أدخل اسم المستخدم">
      </div>
      <div class="mb-6">
        <label for="password" class="block text-gray-400 mb-2">كلمة المرور</label>
        <input type="password" id="password" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-purple-500" placeholder="أدخل كلمة المرور">
      </div>
      <button id="submit-login" class="btn-gradient w-full text-white py-3 rounded-full font-bold">دخول</button>
      <p id="login-message" class="mt-4 text-center font-bold"></p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- CONFIGURATION & STATE ---
      const config = {
          NETLIFY_CHAT_ENDPOINT: "/.netlify/functions/chat",
          ROBOTS: [
            { name: "ألفا (Alfa)", specialization: "مساعد التسويق الرقمي", img: "https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=800&auto=format&fit=crop" },
            { name: "فيزي (Vizi)", specialization: "مساعد المبيعات", img: "https://images.unsplash.com/photo-1551836022-d5d88e-9218df?q=80&w=800&auto=format&fit=crop" },
            { name: "كورتكس (Cortex)", specialization: "مساعد مالي", img: "https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?q=80&w=800&auto=format&fit=crop" },
            { name: "ليكس (Lex)", specialization: "مساعد خدمة العملاء", img: "https://images.unsplash.com/photo-1525182008055-f88b95ff7980?q=80&w=800&auto=format&fit=crop" },
            { name: "أوكتو (Octo)", specialization: "مساعد العمليات", img: "https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?q=80&w=800&auto=format&fit=crop" },
            { name: "مينا (Mina)", specialization: "مساعد تحليل البيانات", img: "https://images.unsplash.com/photo-1556761175-4b46a572b786?q=80&w=800&auto=format&fit=crop" },
            { name: "بولت (Bolt)", specialization: "مساعد إدارة المشاريع", img: "https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=800&auto=format&fit=crop" },
            { name: "ريكس (Rex)", specialization: "مساعد الإدارة المالية", img: "https://images.unsplash.com/photo-1554224154-22dec7ec8818?q=80&w=800&auto=format&fit=crop" },
            { name: "بادي (Buddy)", specialization: "مساعد العلاقات العامة", img: "https://images.unsplash.com/photo-1520975922325-24baf8635f3b?q=80&w=800&auto=format&fit=crop" },
            { name: "روفر (Rover)", specialization: "مساعد علاقات العملاء", img: "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=800&auto=format&fit=crop" },
            { name: "فالور (Valor)", specialization: "مساعد التجارة الإلكترونية", img: "https://images.unsplash.com/photo-1512295767273-ac109ac3acfa?q=80&w=800&auto=format&fit=crop" },
            { name: "زينيث (Zenith)", specialization: "مساعد الابتكار", img: "https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=800&auto=format&fit=crop" },
          ]
      };
      
      let state = {
          currentView: 'landing',
          currentUser: null,
          currentRobot: null,
          companyData: {},
          isLoggedIn: false,
      };

      // --- DOM ELEMENTS ---
      const DOMElements = {
          views: {
              landing: document.getElementById('landing-view'),
              setupChat: document.getElementById('setup-chat-view'),
              dashboard: document.getElementById('dashboard-view'),
              profile: document.getElementById('profile-view'),
              robotChat: document.getElementById('robot-chat-view'),
          },
          login: {
              btn: document.getElementById('login-btn'),
              modal: document.getElementById('login-modal'),
              closeBtn: document.querySelector('.close-btn'),
              submitBtn: document.getElementById('submit-login'),
              usernameInput: document.getElementById('username'),
              passwordInput: document.getElementById('password'),
              message: document.getElementById('login-message'),
          },
          setupChat: {
              messages: document.getElementById('setup-chat-messages'),
              input: document.getElementById('setup-chat-input'),
              sendBtn: document.getElementById('setup-chat-send-btn'),
          },
          dashboard: {
              robotList: document.getElementById('robot-list-dashboard'),
              conversationsList: document.getElementById('conversations-list'),
              profileBtn: document.getElementById('profile-btn'),
              logoutBtn: document.getElementById('logout-btn'),
          },
          profile: {
              backBtn: document.getElementById('back-to-dashboard-from-profile-btn'),
              basicData: document.getElementById('basic-data'),
              learnedData: document.getElementById('learned-data'),
          },
          robotChat: {
              header: document.getElementById('robot-chat-header'),
              messages: document.getElementById('robot-chat-messages'),
              input: document.getElementById('robot-chat-input'),
              sendBtn: document.getElementById('robot-chat-send-btn'),
              backBtn: document.getElementById('back-to-dashboard-btn'),
              fileUpload: document.getElementById('file-upload'),
          },
          landing: {
              robotsGrid: document.getElementById('robots-grid-landing'),
              faqItems: document.querySelectorAll('.faq-item'),
          },
          scrollToBottomBtn: document.getElementById('scroll-to-bottom'),
      };

      // --- UTILITY FUNCTIONS ---
      const LocalStorage = {
          get: (key, defaultValue = null) => {
              try {
                  const item = localStorage.getItem(key);
                  return item ? JSON.parse(item) : defaultValue;
              } catch (e) {
                  console.error(`Error getting item ${key} from localStorage`, e);
                  return defaultValue;
              }
          },
          set: (key, value) => {
              try {
                  localStorage.setItem(key, JSON.stringify(value));
              } catch (e) {
                  console.error(`Error setting item ${key} in localStorage`, e);
              }
          }
      };
      
      const API = {
        async geminiReply(userText, persona, files = [], conversationHistory = []) {
            const company = LocalStorage.get("companyData", {});
            const history = conversationHistory.length > 0 ? conversationHistory : LocalStorage.get(`conversation_${persona}`, []).slice(-20);

            const body = {
                messages: [...history, { role: "user", text: userText }],
                persona,
                company,
                meta: { intent: "general" },
                files,
            };

            try {
                const response = await fetch(config.NETLIFY_CHAT_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();

                if (data && data.memoryPatch && typeof data.memoryPatch === "object") {
                    const prevLearned = LocalStorage.get("aiLearnedData", {});
                    const nextLearned = { ...prevLearned, ...data.memoryPatch };
                    LocalStorage.set("aiLearnedData", nextLearned);
                }

                return data; // Return full response object
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return { text: `⚠️ تعذّر الاتصال بالذكاء الاصطناعي: ${error.message}` };
            }
        },
        fileToBase64: (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const result = reader.result.split(',')[1];
                resolve({ base64: result, mime: file.type, name: file.name });
            };
            reader.onerror = error => reject(error);
        }),
      };

      // --- UI & VIEW MANAGEMENT ---
      const UI = {
          updateView: (viewName) => {
              state.currentView = viewName;
              Object.values(DOMElements.views).forEach(view => view.classList.remove('active'));
              if (DOMElements.views[viewName]) {
                  DOMElements.views[viewName].classList.add('active');
              }
          },
          addMessage: (container, text, sender) => {
              const messageEl = document.createElement('div');
              messageEl.classList.add('chat-message', `${sender}-message`);
              messageEl.textContent = text;
              container.appendChild(messageEl);
              Chat.maybeAutoScroll(container); // WhatsApp-like scroll
          },
          renderRobotCards: (container) => {
              container.innerHTML = '';
              config.ROBOTS.forEach(robot => {
                  const card = document.createElement('div');
                  card.className = 'robot-card';
                  card.dataset.name = robot.name;
                  card.innerHTML = `
                      <div class="robot-circle">
                          <img loading="lazy" src="${robot.img}" alt="${robot.name}" class="robot-image"/>
                      </div>
                      <h4 class="font-bold mt-4 text-white">${robot.name}</h4>
                      <p class="text-sm text-gray-400 mt-2">${robot.specialization}</p>
                  `;
                  if (container === DOMElements.dashboard.robotList) {
                      card.addEventListener('click', () => Controller.startRobotChat(robot.name));
                  }
                  container.appendChild(card);
              });
          },
          renderConversations: () => {
              DOMElements.dashboard.conversationsList.innerHTML = '';
              let hasConvos = false;
              config.ROBOTS.forEach(robot => {
                  const conversation = LocalStorage.get(`conversation_${robot.name}`, []);
                  if (conversation.length > 0) {
                      hasConvos = true;
                      const lastMessage = conversation[conversation.length - 1];
                      const listItem = document.createElement('div');
                      listItem.className = 'bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors flex items-center gap-4';
                      listItem.innerHTML = `
                          <img src="${robot.img}" class="w-12 h-12 rounded-full object-cover">
                          <div>
                            <h4 class="font-bold text-white">${robot.name}</h4>
                            <p class="text-sm text-gray-400 truncate">${lastMessage.sender === 'user' ? 'أنت: ' : ''}${lastMessage.text}</p>
                          </div>
                      `;
                      listItem.addEventListener('click', () => Controller.startRobotChat(robot.name));
                      DOMElements.dashboard.conversationsList.appendChild(listItem);
                  }
              });
              if (!hasConvos) {
                  DOMElements.dashboard.conversationsList.innerHTML = `<p class="text-center text-gray-500">لا توجد محادثات سابقة. ابدأ واحدة!</p>`;
              }
          },
          updateProfile: () => {
              const basicData = LocalStorage.get('companyData', {});
              const learnedData = LocalStorage.get('aiLearnedData', {});
              
              DOMElements.profile.basicData.innerHTML = `
                  <p class="text-gray-300 mb-2"><b>اسم الشركة:</b> ${basicData.name || 'غير متوفر'}</p>
                  <p class="text-gray-300 mb-2"><b>مجال العمل:</b> ${basicData.industry || 'غير متوفر'}</p>
                  <p class="text-gray-300"><b>الأهداف:</b> ${basicData.goals || 'غير متوفر'}</p>
              `;

              const learnedKeys = Object.keys(learnedData);
              if (learnedKeys.length > 0) {
                  DOMElements.profile.learnedData.innerHTML = learnedKeys.map(key => 
                      `<p class="text-gray-300 mb-2"><b>${key}:</b> ${learnedData[key]}</p>`
                  ).join('');
              } else {
                  DOMElements.profile.learnedData.innerHTML = `<p class="text-gray-400">لا توجد معلومات مكتسبة بعد.</p>`;
              }
          },
          toggleModal: (show) => {
              DOMElements.login.modal.style.display = show ? 'flex' : 'none';
          },
      };

      // --- CHAT EXPERIENCE MODULE ---
      const Chat = {
          init: () => {
              const chatContainers = [DOMElements.setupChat.messages, DOMElements.robotChat.messages];
              const chatInputs = [DOMElements.setupChat.input, DOMElements.robotChat.input];
              
              chatContainers.forEach(container => {
                  if(!container) return;
                  container.addEventListener('scroll', () => Chat.updateScrollButtonVisibility(container), { passive: true });
                  const observer = new MutationObserver(() => Chat.maybeAutoScroll(container));
                  observer.observe(container, { childList: true });
              });

              DOMElements.scrollToBottomBtn.addEventListener('click', () => {
                  const activeContainer = state.currentView === 'robotChat' ? DOMElements.robotChat.messages : DOMElements.setupChat.messages;
                  Chat.scrollToBottom(activeContainer);
              });
              
              chatInputs.forEach(input => {
                input.addEventListener('focus', () => {
                    const activeContainer = input === DOMElements.robotChat.input ? DOMElements.robotChat.messages : DOMElements.setupChat.messages;
                    Chat.scrollToBottom(activeContainer);
                });
                // Auto-resize textarea
                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    input.style.height = `${input.scrollHeight}px`;
                });
              });
          },
          isUserAtBottom: (container, threshold = 120) => {
              if (!container) return true;
              return (container.scrollHeight - container.scrollTop - container.clientHeight) < threshold;
          },
          updateScrollButtonVisibility: (container) => {
              const show = !Chat.isUserAtBottom(container, 150);
              DOMElements.scrollToBottomBtn.classList.toggle('show', show);
          },
          scrollToBottom: (container) => {
              if (!container) return;
              container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
          },
          maybeAutoScroll: (container) => {
              if (Chat.isUserAtBottom(container)) {
                  Chat.scrollToBottom(container);
              }
          }
      };
      
      // --- CONTROLLER & EVENT HANDLERS ---
      const Controller = {
          init: () => {
              // General UI
              UI.renderRobotCards(DOMElements.landing.robotsGrid);
              DOMElements.landing.faqItems.forEach(item => item.addEventListener('click', () => item.classList.toggle('active')));
              Controller.setupMobileViewport();

              // Login
              DOMElements.login.btn.addEventListener('click', () => UI.toggleModal(true));
              DOMElements.login.closeBtn.addEventListener('click', () => UI.toggleModal(false));
              DOMElements.login.modal.addEventListener('click', (e) => { if(e.target === DOMElements.login.modal) UI.toggleModal(false); });
              DOMElements.login.submitBtn.addEventListener('click', Controller.handleLogin);

              // Setup Chat
              DOMElements.setupChat.sendBtn.addEventListener('click', Controller.handleSetupChat);
              DOMElements.setupChat.input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); Controller.handleSetupChat(); }});

              // Dashboard
              DOMElements.dashboard.profileBtn.addEventListener('click', Controller.showProfile);
              DOMElements.dashboard.logoutBtn.addEventListener('click', Controller.handleLogout);

              // Profile
              DOMElements.profile.backBtn.addEventListener('click', Controller.showDashboard);

              // Robot Chat
              DOMElements.robotChat.sendBtn.addEventListener('click', Controller.handleRobotChat);
              DOMElements.robotChat.input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); Controller.handleRobotChat(); }});
              DOMElements.robotChat.backBtn.addEventListener('click', Controller.showDashboard);
              DOMElements.robotChat.fileUpload.addEventListener('change', Controller.handleFileUpload);

              // Initialize Chat UX Enhancements
              Chat.init();

              // Check initial state
              if (LocalStorage.get('isLoggedIn')) {
                  Controller.showDashboard();
              } else {
                  UI.updateView('landing');
              }
          },
          
          handleLogin: () => {
            const { usernameInput, passwordInput, message } = DOMElements.login;
            if (usernameInput.value.toLowerCase() === 'aiagent' && passwordInput.value === '159753') {
                message.textContent = 'تم تسجيل الدخول بنجاح!';
                message.style.color = '#10b981';
                LocalStorage.set('isLoggedIn', true);
                setTimeout(() => {
                    UI.toggleModal(false);
                    if (LocalStorage.get('companyData') && Object.keys(LocalStorage.get('companyData')).length > 0) {
                        Controller.showDashboard();
                    } else {
                        Controller.startSetupChat();
                    }
                }, 1000);
            } else {
                message.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
                message.style.color = '#ef4444';
            }
          },

          handleLogout: () => {
              LocalStorage.set('isLoggedIn', false);
              UI.updateView('landing');
          },
          
          startSetupChat: () => {
              LocalStorage.set('companyData', {}); // Clear old data
              DOMElements.setupChat.messages.innerHTML = '';
              UI.updateView('setupChat');
              const initialPrompt = "مرحباً بك! أنا مساعد الإعداد الذكي. لكي أتمكن من تجهيز فريقك، أحتاج إلى فهم طبيعة عملك. لنبدأ، ما هو اسم شركتك وما هو نشاطها الرئيسي؟";
              UI.addMessage(DOMElements.setupChat.messages, initialPrompt, 'ai');
              LocalStorage.set('conversation_setup', [{ text: initialPrompt, sender: 'ai' }]);
          },

          handleSetupChat: async () => {
              const input = DOMElements.setupChat.input;
              const userMessage = input.value.trim();
              if (userMessage === '') return;
              
              UI.addMessage(DOMElements.setupChat.messages, userMessage, 'user');
              input.value = '';
              input.style.height = 'auto';
              
              const conversation = LocalStorage.get('conversation_setup', []);
              conversation.push({ text: userMessage, sender: 'user' });
              
              const response = await API.geminiReply(userMessage, 'setup_assistant', [], conversation);

              UI.addMessage(DOMElements.setupChat.messages, response.text, 'ai');
              conversation.push({ text: response.text, sender: 'ai' });
              LocalStorage.set('conversation_setup', conversation);

              // The AI will tell us when the setup is complete
              if (response.setupComplete && response.companyData) {
                  LocalStorage.set('companyData', response.companyData);
                  UI.addMessage(DOMElements.setupChat.messages, "ممتاز! لقد اكتمل ملفك بنجاح. يتم الآن إعداد أدواتك.", 'ai');
                  setTimeout(() => {
                      Controller.showDashboard();
                  }, 2500);
              }
          },

          showDashboard: () => {
              UI.updateView('dashboard');
              UI.renderRobotCards(DOMElements.dashboard.robotList);
              UI.renderConversations();
          },

          showProfile: () => {
              UI.updateView('profile');
              UI.updateProfile();
          },

          startRobotChat: (robotName) => {
              state.currentRobot = robotName;
              DOMElements.robotChat.header.textContent = `محادثة مع ${robotName}`;
              DOMElements.robotChat.messages.innerHTML = '';
              UI.updateView('robotChat');

              const conversation = LocalStorage.get(`conversation_${robotName}`, []);
              if (conversation.length > 0) {
                  conversation.forEach(msg => UI.addMessage(DOMElements.robotChat.messages, msg.text, msg.sender));
              } else {
                  // No canned responses.
              }
              setTimeout(() => Chat.scrollToBottom(DOMElements.robotChat.messages), 100);
          },
          
          handleRobotChat: async () => {
              const input = DOMElements.robotChat.input;
              const userMessage = input.value.trim();
              if (userMessage === '' || !state.currentRobot) return;

              UI.addMessage(DOMElements.robotChat.messages, userMessage, 'user');
              input.value = '';
              input.style.height = 'auto';

              const conversation = LocalStorage.get(`conversation_${state.currentRobot}`, []);
              conversation.push({ text: userMessage, sender: 'user' });
              LocalStorage.set(`conversation_${state.currentRobot}`, conversation);

              const response = await API.geminiReply(userMessage, state.currentRobot);
              UI.addMessage(DOMElements.robotChat.messages, response.text, 'ai');

              conversation.push({ text: response.text, sender: 'ai' });
              LocalStorage.set(`conversation_${state.currentRobot}`, conversation);
          },

          handleFileUpload: async (e) => {
              const file = e.target.files[0];
              if (!file || !state.currentRobot) return;

              const userMsg = `تم رفع "${file.name}" — جاري التحليل...`;
              UI.addMessage(DOMElements.robotChat.messages, userMsg, 'user');
              
              const conversation = LocalStorage.get(`conversation_${state.currentRobot}`, []);
              conversation.push({ text: userMsg, sender: 'user' });
              LocalStorage.set(`conversation_${state.currentRobot}`, conversation);

              try {
                  const fileData = await API.fileToBase64(file);
                  const prompt = `لقد قمت برفع هذا الملف (${file.name}). يرجى تحليله وتقديم ملخص أو رؤى رئيسية بناءً على محتواه.`;
                  const response = await API.geminiReply(prompt, state.currentRobot, [fileData]);
                  
                  UI.addMessage(DOMElements.robotChat.messages, response.text, 'ai');
                  conversation.push({ text: response.text, sender: 'ai' });
              } catch (err) {
                  const failMsg = `⚠️ تعذّر معالجة الملف: ${err.message}`;
                  UI.addMessage(DOMElements.robotChat.messages, failMsg, 'ai');
                  conversation.push({ text: failMsg, sender: 'ai' });
              } finally {
                  LocalStorage.set(`conversation_${state.currentRobot}`, conversation);
                  e.target.value = ''; // Reset file input
              }
          },

          setupMobileViewport: () => {
              const setVh = () => {
                  const vh = window.innerHeight * 0.01;
                  document.documentElement.style.setProperty('--vh', `${vh}px`);
              };
              setVh();
              window.addEventListener('resize', setVh);
          },
      };

      // --- INITIALIZE THE APP ---
      Controller.init();
    });
  </script>

</body>
</html>

