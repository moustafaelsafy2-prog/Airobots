<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة الأدمن — إدارة المستخدمين (ستاتيكي)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{--bg:#0d1117;--card:#161b22;--muted:#9ca3af;--accent1:#60a5fa;--accent2:#8b5cf6;--success:#10b981;--danger:#ef4444}
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6edf3}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    .card{background:var(--card);border:1px solid #2b3036;border-radius:12px;padding:18px;box-shadow:0 6px 22px rgba(2,6,23,.6)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    label{display:block;color:var(--muted);margin:8px 0 6px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2b3036;background:#0f1418;color:#fff}
    button{cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:0;color:#fff;padding:10px 16px}
    .btn-ghost{background:transparent;border:1px solid #333;color:var(--muted)}
    .flex{display:flex;gap:12px;align-items:center}
    .space-between{justify-content:space-between}
    .hidden{display:none}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{padding:10px;border-bottom:1px solid #222;text-align:right;color:#d1d5db}
    .small{font-size:13px;color:var(--muted)}
    .actions button{margin-left:6px}
    .search-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1720;border:1px solid #222;color:var(--muted);font-size:13px}
    .msg{padding:8px;border-radius:8px;margin:6px 0;font-size:14px}
    .msg.success{background:#052b1f;color:var(--success)}
    .msg.error{background:#2b0b0b;color:var(--danger)}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>لوحة الأدمن — إدارة المستخدمين (ستاتيكي)</h1>
        <div>
          <a href="index.html" class="btn-ghost">الصفحة الرئيسية</a>
        </div>
      </header>

      <div class="card" style="margin-bottom:12px">
        <div class="search-row">
          <input id="searchInput" placeholder="ابحث باسم المستخدم أو البريد..." />
          <select id="filterRole">
            <option value="">كل الأدوار</option>
            <option value="user">مستخدم</option>
            <option value="manager">مدير</option>
            <option value="editor">محرر</option>
          </select>
          <button id="addUserBtn" class="btn-primary" style="width:150px">إضافة مستخدم</button>

          <button id="loadGlobalBtn" class="btn-ghost" title="قراءة users.json">تحميل من users.json</button>
          <button id="exportBtn" class="btn-ghost" title="تصدير JSON وحفظه كـ users.json">تصدير JSON</button>
          <input type="file" id="importFile" class="hidden" accept=".json" />
          <button id="importBtn" class="btn-ghost">استيراد JSON</button>
        </div>
        <div class="small">نمط التخزين: محلي عبر <code>localStorage</code> + ملف عالمي اختياري <code>users.json</code>.</div>
      </div>

      <div class="card">
        <table class="table" id="usersTable" aria-live="polite">
          <thead>
            <tr>
              <th>اسم المستخدم</th>
              <th>البريد</th>
              <th>الدور</th>
              <th>ملاحظات</th>
              <th style="width:220px;text-align:center">إجراءات</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
        <div id="tableMsg" class="small" style="margin-top:10px"></div>
      </div>
    </div>

    <footer>
      حدّث ملف <code>users.json</code> في الريبو ليتاح للجميع عبر أي متصفح.  
      كلمات المرور مخزّنة Base64 لأغراض الـ MVP فقط.
    </footer>
  </div>

  <!-- Modal بسيط للإضافة/التعديل -->
  <div id="modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center">
    <div class="card" style="width:95%;max-width:700px">
      <h3 id="modalTitle">إضافة مستخدم</h3>
      <div id="modalMsg"></div>
      <div class="flex" style="flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <label>اسم المستخدم</label>
          <input id="m_username" placeholder="username" />
        </div>
        <div style="flex:1;min-width:260px">
          <label>البريد</label>
          <input id="m_email" placeholder="example@mail.com" />
        </div>
      </div>
      <div class="flex" style="flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <label>كلمة المرور</label>
          <input id="m_password" type="password" placeholder="password" />
        </div>
        <div style="flex:1;min-width:260px">
          <label>الدور</label>
          <select id="m_role">
            <option value="user">مستخدم</option>
            <option value="manager">مدير</option>
            <option value="editor">محرر</option>
          </select>
        </div>
      </div>
      <label>ملاحظات</label>
      <textarea id="m_notes" rows="3" placeholder="ملاحظات اختيارية"></textarea>
      <div class="flex" style="margin-top:10px">
        <button id="saveUserBtn" class="btn-primary">حفظ</button>
        <button id="cancelUserBtn" class="btn-ghost">إلغاء</button>
      </div>
    </div>
  </div>

<script>
const LS_USERS = 'app_users';
const usersTbody = document.getElementById('usersTbody');
const tableMsg = document.getElementById('tableMsg');
const searchInput = document.getElementById('searchInput');
const filterRole = document.getElementById('filterRole');
const addUserBtn = document.getElementById('addUserBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const loadGlobalBtn = document.getElementById('loadGlobalBtn');

const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalMsg = document.getElementById('modalMsg');
const m_username = document.getElementById('m_username');
const m_email = document.getElementById('m_email');
const m_password = document.getElementById('m_password');
const m_role = document.getElementById('m_role');
const m_notes = document.getElementById('m_notes');
const saveUserBtn = document.getElementById('saveUserBtn');
const cancelUserBtn = document.getElementById('cancelUserBtn');

let editId = null;

function genId(){ return 'u_'+Math.random().toString(36).slice(2,9); }
function loadUsers(){ try{ return JSON.parse(localStorage.getItem(LS_USERS) || '[]'); } catch(e){ return []; } }
function saveUsers(arr){ localStorage.setItem(LS_USERS, JSON.stringify(arr)); }
function esc(s=''){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function b64(s){ return btoa(s || ''); }
function b64d(s){ try{ return atob(s || ''); } catch(e){ return ''; } }

async function loadGlobalUsers(){
  try{
    const res = await fetch('users.json', { cache:'no-store' });
    if(!res.ok) throw new Error('لا يمكن قراءة users.json');
    const arr = await res.json();
    alert('تم تحميل '+arr.length+' مستخدم من users.json (قراءة فقط). لا يُخزَّنون تلقائيًا محليًا.');
    return arr;
  } catch(e){
    alert(e.message);
    return [];
  }
}

function render(list){
  const allLocal = list ?? loadUsers();
  const q = (searchInput.value || '').toLowerCase().trim();
  const rf = filterRole.value;

  const filtered = allLocal.filter(x=>{
    const matchQ = !q || (x.username+' '+(x.email||'')+' '+(x.notes||'')).toLowerCase().includes(q);
    const matchR = !rf || x.role === rf;
    return matchQ && matchR;
  });

  usersTbody.innerHTML = filtered.length ? '' : `<tr><td colspan="5" class="small" style="text-align:center;color:#9ca3af">لا توجد نتائج</td></tr>`;
  filtered.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(u.username)}</td>
      <td>${esc(u.email || '-')}</td>
      <td>${esc(u.role || 'user')}</td>
      <td class="small">${esc(u.notes || '')}</td>
      <td style="text-align:center">
        <button class="btn-ghost" data-act="view" data-id="${u.id}">عرض</button>
        <button class="btn-primary" data-act="edit" data-id="${u.id}">تعديل</button>
        <button class="btn-ghost" data-act="del"  data-id="${u.id}">حذف</button>
      </td>`;
    usersTbody.appendChild(tr);
  });
  tableMsg.textContent = `إجمالي محلي: ${loadUsers().length} — المعروض: ${filtered.length}`;

  usersTbody.querySelectorAll('button').forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute('data-id');
      const act = b.getAttribute('data-act');
      if(act==='view') return viewUser(id);
      if(act==='edit') return openEdit(id);
      if(act==='del')  return delUser(id);
    };
  });
}

function openAdd(){
  editId=null; modalTitle.textContent='إضافة مستخدم';
  m_username.value=''; m_email.value=''; m_password.value=''; m_role.value='user'; m_notes.value='';
  modalMsg.innerHTML=''; modal.classList.remove('hidden'); m_username.focus();
}
function openEdit(id){
  const u = loadUsers().find(x=>x.id===id); if(!u) return;
  editId=id; modalTitle.textContent='تعديل مستخدم';
  m_username.value=u.username; m_email.value=u.email||''; m_password.value=b64d(u.pass||''); m_role.value=u.role||'user'; m_notes.value=u.notes||'';
  modalMsg.innerHTML=''; modal.classList.remove('hidden'); m_username.focus();
}
function viewUser(id){
  const u=loadUsers().find(x=>x.id===id); if(!u) return;
  alert(`اسم المستخدم: ${u.username}\nالبريد: ${u.email||'-'}\nالدور: ${u.role}\nملاحظات: ${u.notes||'-'}`);
}
function delUser(id){
  if(!confirm('حذف المستخدم؟')) return;
  saveUsers(loadUsers().filter(x=>x.id!==id));
  render();
}

function saveUser(){
  const username=m_username.value.trim();
  const email=m_email.value.trim();
  const password=m_password.value;
  const role=m_role.value;
  const notes=m_notes.value.trim();

  if(!username){ modalMsg.innerHTML='<div class="msg error">أدخل اسم المستخدم</div>'; return; }
  if(!password){ modalMsg.innerHTML='<div class="msg error">أدخل كلمة المرور</div>'; return; }

  let list=loadUsers();
  if(editId){
    list = list.map(x=> x.id===editId ? {...x,username,email,pass:b64(password),role,notes} : x);
  } else {
    if(list.some(x=>x.username.toLowerCase()===username.toLowerCase())){
      modalMsg.innerHTML='<div class="msg error">اسم المستخدم موجود</div>'; return;
    }
    list.unshift({id:genId(), username, email, pass:b64(password), role, notes});
  }
  saveUsers(list);
  modal.classList.add('hidden');
  render();
}

/* Export/Import/Global */
exportBtn.onclick=()=>{
  const blob=new Blob([JSON.stringify(loadUsers(),null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='users.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  alert('تم تنزيل users.json — ارفعه/استبدله في الريبو ليصبح عالميًا عبر أي متصفح.');
};
importBtn.onclick=()=>importFile.click();
importFile.onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=evt=>{
    try{
      const arr=JSON.parse(evt.target.result);
      if(!Array.isArray(arr)) throw new Error('ملف غير صالح');
      // توحيد البنية
      const cleaned=arr.map(u=>({
        id: u.id || genId(),
        username: u.username || ('user_'+Math.random().toString(36).slice(2,6)),
        email: u.email || '',
        pass: u.pass || b64('password'),
        role: u.role || 'user',
        notes: u.notes || ''
      }));
      saveUsers(cleaned);
      alert('تم الاستيراد محليًا. لتعميمه: صدّر الملف وبدّل users.json في الريبو.');
      render();
    }catch(err){ alert('فشل الاستيراد: '+err.message); }
    finally{ importFile.value=''; }
  };
  rd.readAsText(f);
};

loadGlobalBtn.onclick=async()=>{
  const global = await loadGlobalUsers();
  // عرض القراءة العالمية دون حفظ محلي
  render(global);
};

addUserBtn.onclick=openAdd;
cancelUserBtn.onclick=()=>modal.classList.add('hidden');
saveUserBtn.onclick=saveUser;
searchInput.oninput=render;
filterRole.onchange=render;

document.addEventListener('DOMContentLoaded', ()=> render());
</script>
</body>
</html>
